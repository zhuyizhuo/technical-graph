# ğŸŒ å¾®æœåŠ¡æ¶æ„è®¾è®¡

## ä¸€ã€å¾®æœåŠ¡æ¶æ„æ¦‚è¿°

å¾®æœåŠ¡æ¶æ„æ˜¯ä¸€ç§å°†å•ä¸€åº”ç”¨ç¨‹åºåˆ’åˆ†ä¸ºä¸€ç»„å°å‹ã€ç‹¬ç«‹çš„æœåŠ¡çš„æ¶æ„é£æ ¼ï¼Œæ¯ä¸ªæœåŠ¡å›´ç»•ç‰¹å®šçš„ä¸šåŠ¡åŠŸèƒ½æ„å»ºï¼Œå¯ä»¥ç‹¬ç«‹éƒ¨ç½²å’Œæ‰©å±•ã€‚å¾®æœåŠ¡æ¶æ„æ—¨åœ¨è§£å†³å•ä½“åº”ç”¨åœ¨è§„æ¨¡å¢é•¿å’Œå¤æ‚åº¦æé«˜æ—¶é¢ä¸´çš„æŒ‘æˆ˜ã€‚

### 1.1 å¾®æœåŠ¡æ¶æ„çš„æ ¸å¿ƒç‰¹å¾

- **æœåŠ¡ç»„ä»¶åŒ–**ï¼šå°†ç³»ç»Ÿæ‹†åˆ†ä¸ºç‹¬ç«‹çš„ã€å¯éƒ¨ç½²çš„æœåŠ¡ç»„ä»¶
- **å›´ç»•ä¸šåŠ¡èƒ½åŠ›ç»„ç»‡**ï¼šæŒ‰ç…§ä¸šåŠ¡é¢†åŸŸæˆ–èƒ½åŠ›åˆ’åˆ†æœåŠ¡è¾¹ç•Œ
- **ç‹¬ç«‹éƒ¨ç½²**ï¼šæ¯ä¸ªæœåŠ¡å¯ä»¥ç‹¬ç«‹éƒ¨ç½²ï¼Œä¸å½±å“å…¶ä»–æœåŠ¡
- **åˆ†å¸ƒå¼æ•°æ®ç®¡ç†**ï¼šæ¯ä¸ªæœåŠ¡å¯ä»¥æ‹¥æœ‰è‡ªå·±çš„æ•°æ®å­˜å‚¨
- **æœåŠ¡é—´é€šä¿¡**ï¼šé€šè¿‡è½»é‡çº§é€šä¿¡æœºåˆ¶ï¼ˆå¦‚HTTP/RESTã€æ¶ˆæ¯é˜Ÿåˆ—ï¼‰å®ç°æœåŠ¡é—´åä½œ
- **æŠ€æœ¯å¤šæ ·æ€§**ï¼šä¸åŒæœåŠ¡å¯ä»¥ä½¿ç”¨é€‚åˆå…¶éœ€æ±‚çš„ä¸åŒæŠ€æœ¯æ ˆ
- **å®¹é”™è®¾è®¡**ï¼šé€šè¿‡æœåŠ¡éš”ç¦»ã€ç†”æ–­ã€é™çº§ç­‰æœºåˆ¶æé«˜ç³»ç»Ÿæ•´ä½“å¯é æ€§

### 1.2 å¾®æœåŠ¡æ¶æ„çš„ä¼˜ç¼ºç‚¹

**ä¼˜ç‚¹**ï¼š
- **æé«˜å¼€å‘æ•ˆç‡**ï¼šå°å›¢é˜Ÿä¸“æ³¨äºç‰¹å®šæœåŠ¡ï¼ŒèŒè´£æ˜ç¡®
- **å¢å¼ºç³»ç»Ÿå¼¹æ€§**ï¼šå•ä¸ªæœåŠ¡æ•…éšœä¸ä¼šå¯¼è‡´æ•´ä¸ªç³»ç»Ÿå´©æºƒ
- **æ”¯æŒæŠ€æœ¯å¤šæ ·æ€§**ï¼šå¯ä»¥ä¸ºä¸åŒæœåŠ¡é€‰æ‹©æœ€é€‚åˆçš„æŠ€æœ¯
- **ç®€åŒ–éƒ¨ç½²**ï¼šç‹¬ç«‹éƒ¨ç½²é™ä½äº†éƒ¨ç½²é£é™©å’Œå¤æ‚åº¦
- **æ›´å¥½çš„å¯æ‰©å±•æ€§**ï¼šå¯ä»¥æ ¹æ®éœ€æ±‚ç‹¬ç«‹æ‰©å±•å„ä¸ªæœåŠ¡
- **ä¿ƒè¿›ç»„ç»‡å˜é©**ï¼šæ¨åŠ¨å›¢é˜Ÿç»“æ„å‘æ›´æ‰å¹³ã€æ›´æ•æ·çš„æ–¹å‘å‘å±•

**ç¼ºç‚¹**ï¼š
- **åˆ†å¸ƒå¼ç³»ç»Ÿå¤æ‚æ€§**ï¼šæœåŠ¡é—´é€šä¿¡ã€åˆ†å¸ƒå¼äº‹åŠ¡ç­‰é—®é¢˜
- **è¿ç»´å¤æ‚åº¦å¢åŠ **ï¼šéœ€è¦ç®¡ç†å¤§é‡ç‹¬ç«‹éƒ¨ç½²çš„æœåŠ¡
- **æœåŠ¡é—´ä¾èµ–ç®¡ç†**ï¼šæœåŠ¡é—´ä¾èµ–å…³ç³»å¤æ‚ï¼Œç‰ˆæœ¬æ§åˆ¶å›°éš¾
- **æ•°æ®ä¸€è‡´æ€§æŒ‘æˆ˜**ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æ•°æ®ä¸€è‡´æ€§éš¾ä»¥ä¿è¯
- **æµ‹è¯•å¤æ‚æ€§å¢åŠ **ï¼šç«¯åˆ°ç«¯æµ‹è¯•å˜å¾—æ›´åŠ å¤æ‚
- **ç›‘æ§å’Œè¿½è¸ªéš¾åº¦**ï¼šéœ€è¦æ›´å®Œå–„çš„ç›‘æ§å’Œè¿½è¸ªç³»ç»Ÿ

### 1.3 å¾®æœåŠ¡æ¶æ„çš„é€‚ç”¨åœºæ™¯

å¾®æœåŠ¡æ¶æ„ç‰¹åˆ«é€‚åˆä»¥ä¸‹åœºæ™¯ï¼š
- **å¤§å‹å¤æ‚åº”ç”¨**ï¼šä¸šåŠ¡åŠŸèƒ½ä¸°å¯Œã€å›¢é˜Ÿè§„æ¨¡è¾ƒå¤§çš„åº”ç”¨
- **å¿«é€Ÿè¿­ä»£éœ€æ±‚**ï¼šéœ€è¦é¢‘ç¹å‘å¸ƒå’Œæ›´æ–°çš„åº”ç”¨
- **é«˜å¯ç”¨æ€§è¦æ±‚**ï¼šå¯¹ç³»ç»Ÿå¯ç”¨æ€§è¦æ±‚è¾ƒé«˜çš„åº”ç”¨
- **å¤šæ ·åŒ–æŠ€æœ¯éœ€æ±‚**ï¼šä¸åŒåŠŸèƒ½æ¨¡å—æœ‰ä¸åŒæŠ€æœ¯éœ€æ±‚çš„åº”ç”¨
- **å¼¹æ€§ä¼¸ç¼©éœ€æ±‚**ï¼šéœ€è¦æ ¹æ®ä¸šåŠ¡è´Ÿè½½åŠ¨æ€è°ƒæ•´èµ„æºçš„åº”ç”¨

## äºŒã€æœåŠ¡æ‹†åˆ†ç­–ç•¥

æœåŠ¡æ‹†åˆ†æ˜¯å¾®æœåŠ¡æ¶æ„è®¾è®¡çš„æ ¸å¿ƒç¯èŠ‚ï¼Œåˆç†çš„æœåŠ¡æ‹†åˆ†å¯ä»¥å……åˆ†å‘æŒ¥å¾®æœåŠ¡çš„ä¼˜åŠ¿ï¼Œä¸åˆç†çš„æ‹†åˆ†åˆ™ä¼šå¸¦æ¥æ›´å¤šçš„é—®é¢˜ã€‚

### 2.1 æœåŠ¡æ‹†åˆ†çš„åŸåˆ™

- **å•ä¸€èŒè´£åŸåˆ™**ï¼šæ¯ä¸ªæœåŠ¡ä¸“æ³¨äºä¸€ä¸ªæ˜ç¡®çš„ä¸šåŠ¡é¢†åŸŸ
- **é«˜å†…èšä½è€¦åˆ**ï¼šæœåŠ¡å†…éƒ¨é«˜åº¦å†…èšï¼ŒæœåŠ¡ä¹‹é—´æ¾è€¦åˆ
- **å›´ç»•ä¸šåŠ¡èƒ½åŠ›**ï¼šæŒ‰ç…§ä¸šåŠ¡èƒ½åŠ›è€ŒéæŠ€æœ¯åŠŸèƒ½è¿›è¡Œæ‹†åˆ†
- **é™ç•Œä¸Šä¸‹æ–‡**ï¼šå‚è€ƒé¢†åŸŸé©±åŠ¨è®¾è®¡(DDD)çš„é™ç•Œä¸Šä¸‹æ–‡æ¦‚å¿µ
- **ç‹¬ç«‹éƒ¨ç½²å’Œæ‰©å±•**ï¼šç¡®ä¿æœåŠ¡å¯ä»¥ç‹¬ç«‹éƒ¨ç½²å’Œæ‰©å±•
- **å¯æµ‹è¯•æ€§**ï¼šæœåŠ¡åº”è¯¥æ˜“äºæµ‹è¯•ï¼ŒåŒ…æ‹¬å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•å’Œå¥‘çº¦æµ‹è¯•
- **æ•°æ®è‡ªæ²»**ï¼šæ¯ä¸ªæœåŠ¡æ‹¥æœ‰è‡ªå·±çš„æ•°æ®å­˜å‚¨

### 2.2 æœåŠ¡æ‹†åˆ†çš„æ–¹æ³•

#### 2.2.1 åŸºäºé¢†åŸŸé©±åŠ¨è®¾è®¡(DDD)çš„æœåŠ¡æ‹†åˆ†

é¢†åŸŸé©±åŠ¨è®¾è®¡(DDD)æä¾›äº†ä¸°å¯Œçš„æ¦‚å¿µå’Œæ–¹æ³•æ¥æŒ‡å¯¼æœåŠ¡æ‹†åˆ†ï¼š

1. **è¯†åˆ«æ ¸å¿ƒåŸŸå’Œå­åŸŸ**ï¼šåˆ†æä¸šåŠ¡é¢†åŸŸï¼Œè¯†åˆ«æ ¸å¿ƒåŸŸã€æ”¯æ’‘åŸŸå’Œé€šç”¨åŸŸ
2. **åˆ’åˆ†é™ç•Œä¸Šä¸‹æ–‡**ï¼šæ ¹æ®ä¸šåŠ¡è¾¹ç•Œåˆ’åˆ†é™ç•Œä¸Šä¸‹æ–‡
3. **æ˜ å°„åˆ°å¾®æœåŠ¡**ï¼šå°†é™ç•Œä¸Šä¸‹æ–‡æ˜ å°„åˆ°å¾®æœåŠ¡
4. **è¯†åˆ«èšåˆå’Œå®ä½“**ï¼šåœ¨æ¯ä¸ªé™ç•Œä¸Šä¸‹æ–‡ä¸­è¯†åˆ«èšåˆå’Œå®ä½“
5. **è®¾è®¡æœåŠ¡æ¥å£**ï¼šåŸºäºèšåˆå’Œå®ä½“è®¾è®¡æœåŠ¡æ¥å£

**ç¤ºä¾‹**ï¼šç”µå•†ç³»ç»Ÿçš„æœåŠ¡æ‹†åˆ†

```
ç”µå•†ç³»ç»Ÿ
â”œâ”€â”€ ç”¨æˆ·æœåŠ¡ (User Service)
â”‚   â”œâ”€â”€ ç”¨æˆ·ç®¡ç†
â”‚   â”œâ”€â”€ è§’è‰²æƒé™
â”‚   â””â”€â”€ ç”¨æˆ·åå¥½
â”œâ”€â”€ å•†å“æœåŠ¡ (Product Service)
â”‚   â”œâ”€â”€ å•†å“ç®¡ç†
â”‚   â”œâ”€â”€ å•†å“åˆ†ç±»
â”‚   â””â”€â”€ å•†å“å±æ€§
â”œâ”€â”€ è®¢å•æœåŠ¡ (Order Service)
â”‚   â”œâ”€â”€ è®¢å•ç®¡ç†
â”‚   â”œâ”€â”€ è®¢å•é¡¹ç®¡ç†
â”‚   â””â”€â”€ è®¢å•çŠ¶æ€æµè½¬
â”œâ”€â”€ æ”¯ä»˜æœåŠ¡ (Payment Service)
â”‚   â”œâ”€â”€ æ”¯ä»˜å¤„ç†
â”‚   â”œâ”€â”€ æ”¯ä»˜æ–¹å¼ç®¡ç†
â”‚   â””â”€â”€ äº¤æ˜“è®°å½•
â”œâ”€â”€ åº“å­˜æœåŠ¡ (Inventory Service)
â”‚   â”œâ”€â”€ åº“å­˜ç®¡ç†
â”‚   â”œâ”€â”€ åº“å­˜é¢„è­¦
â”‚   â””â”€â”€ åº“å­˜ç§»åŠ¨è®°å½•
â””â”€â”€ æ¨èæœåŠ¡ (Recommendation Service)
    â”œâ”€â”€ ä¸ªæ€§åŒ–æ¨è
    â””â”€â”€ çƒ­é—¨å•†å“æ¨è
```

#### 2.2.2 åŸºäºä¸šåŠ¡æµç¨‹çš„æœåŠ¡æ‹†åˆ†

åŸºäºä¸šåŠ¡æµç¨‹è¿›è¡ŒæœåŠ¡æ‹†åˆ†ï¼Œè¯†åˆ«ä¸šåŠ¡æµç¨‹ä¸­çš„å…³é”®ç¯èŠ‚å’Œå†³ç­–ç‚¹ï¼Œå°†å…¶æ‹†åˆ†ä¸ºç‹¬ç«‹çš„æœåŠ¡ã€‚

**ç¤ºä¾‹**ï¼šè®¢å•å¤„ç†æµç¨‹çš„æœåŠ¡æ‹†åˆ†

```
è®¢å•å¤„ç†æµç¨‹
â”œâ”€â”€ è®¢å•åˆ›å»ºæœåŠ¡
â”‚   â”œâ”€â”€ éªŒè¯è®¢å•æ•°æ®
â”‚   â”œâ”€â”€ æ£€æŸ¥å•†å“åº“å­˜
â”‚   â””â”€â”€ åˆ›å»ºè®¢å•è®°å½•
â”œâ”€â”€ è®¢å•æ”¯ä»˜æœåŠ¡
â”‚   â”œâ”€â”€ ç”Ÿæˆæ”¯ä»˜é“¾æ¥
â”‚   â”œâ”€â”€ å¤„ç†æ”¯ä»˜ç»“æœ
â”‚   â””â”€â”€ æ›´æ–°è®¢å•çŠ¶æ€
â”œâ”€â”€ è®¢å•å±¥è¡ŒæœåŠ¡
â”‚   â”œâ”€â”€ å®‰æ’å‘è´§
â”‚   â”œâ”€â”€ æ›´æ–°ç‰©æµä¿¡æ¯
â”‚   â””â”€â”€ ç¡®è®¤æ”¶è´§
â””â”€â”€ è®¢å•å”®åæœï¿½åŠ¡
    â”œâ”€â”€ å¤„ç†é€€æ¬¾ç”³è¯·
    â”œâ”€â”€ å¤„ç†é€€è´§è¯·æ±‚
    â””â”€â”€ å¤„ç†æŠ•è¯‰å»ºè®®
```

#### 2.2.3 åŸºäºæ•°æ®æ¨¡å‹çš„æœåŠ¡æ‹†åˆ†

åŸºäºæ•°æ®æ¨¡å‹è¿›è¡ŒæœåŠ¡æ‹†åˆ†ï¼Œå°†å…·æœ‰ç´§å¯†å…³ç³»çš„æ•°æ®å®ä½“ç»„åˆåœ¨ä¸€èµ·ï¼Œå½¢æˆç‹¬ç«‹çš„æœåŠ¡ã€‚

**ç¤ºä¾‹**ï¼šåŸºäºæ•°æ®æ¨¡å‹çš„æœåŠ¡æ‹†åˆ†

```
æ•°æ®æ¨¡å‹
â”œâ”€â”€ ç”¨æˆ·ç›¸å…³
â”‚   â”œâ”€â”€ User
â”‚   â”œâ”€â”€ Role
â”‚   â””â”€â”€ Permission
â”œâ”€â”€ å•†å“ç›¸å…³
â”‚   â”œâ”€â”€ Product
â”‚   â”œâ”€â”€ Category
â”‚   â””â”€â”€ Attribute
â”œâ”€â”€ è®¢å•ç›¸å…³
â”‚   â”œâ”€â”€ Order
â”‚   â”œâ”€â”€ OrderItem
â”‚   â””â”€â”€ OrderStatus
â””â”€â”€ æ”¯ä»˜ç›¸å…³
    â”œâ”€â”€ Payment
    â”œâ”€â”€ Transaction
    â””â”€â”€ PaymentMethod
```

### 2.3 æœåŠ¡æ‹†åˆ†çš„å¸¸è§è¯¯åŒº

- **è¿‡åº¦æ‹†åˆ†**ï¼šå°†æœåŠ¡æ‹†åˆ†å¾—è¿‡äºç»†å°ï¼Œå¯¼è‡´æœåŠ¡æ•°é‡è¿‡å¤šï¼Œç®¡ç†å’Œé€šä¿¡æˆæœ¬å¢åŠ 
- **æŠ€æœ¯é©±åŠ¨æ‹†åˆ†**ï¼šåŸºäºæŠ€æœ¯å®ç°è€Œéä¸šåŠ¡é¢†åŸŸè¿›è¡Œæ‹†åˆ†
- **å…±äº«æ•°æ®åº“**ï¼šå¤šä¸ªæœåŠ¡å…±äº«åŒä¸€ä¸ªæ•°æ®åº“ï¼Œå¯¼è‡´æœåŠ¡é—´è€¦åˆåº¦é«˜
- **æ‹†åˆ†ä¸å½»åº•**ï¼šæœåŠ¡ä¹‹é—´å­˜åœ¨è¿‡å¤šçš„ä¾èµ–å’Œå…±äº«ä»£ç 
- **å¿½ç•¥æ•°æ®ä¸€è‡´æ€§**ï¼šæ²¡æœ‰è€ƒè™‘åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æ•°æ®ä¸€è‡´æ€§é—®é¢˜
- **è¿èƒŒå•ä¸€èŒè´£**ï¼šä¸€ä¸ªæœåŠ¡è´Ÿè´£å¤šä¸ªä¸ç›¸å…³çš„ä¸šåŠ¡åŠŸèƒ½

### 2.4 æœåŠ¡æ‹†åˆ†çš„æ¼”è¿›ç­–ç•¥

æœåŠ¡æ‹†åˆ†æ˜¯ä¸€ä¸ªæ¸è¿›å¼çš„è¿‡ç¨‹ï¼Œä¸åº”è¯¥è¯•å›¾ä¸€è¹´è€Œå°±ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›æ¼”è¿›ç­–ç•¥ï¼š

1. **ä»å•ä½“åˆ°å¾®æœåŠ¡**ï¼šå…ˆä¿æŒå•ä½“åº”ç”¨çš„ç¨³å®šè¿è¡Œï¼Œç„¶åé€æ­¥å°†ä¸€äº›æ¨¡å—æ‹†åˆ†ä¸ºç‹¬ç«‹çš„æœåŠ¡
2. ** strangler patternï¼ˆç»æ€è€…æ¨¡å¼ï¼‰**ï¼šæ–°å»ºæœåŠ¡æ¥æ›¿ä»£å•ä½“åº”ç”¨çš„éƒ¨åˆ†åŠŸèƒ½ï¼Œé€æ­¥æ›¿æ¢æ•´ä¸ªåº”ç”¨
3. **åˆ†æ”¯ç­–ç•¥**ï¼šåœ¨ä»£ç ä»“åº“ä¸­ä½¿ç”¨åˆ†æ”¯æ¥è¿›è¡ŒæœåŠ¡æ‹†åˆ†çš„å®éªŒ
4. **æ•°æ®è¿ç§»ç­–ç•¥**ï¼šåˆ¶å®šè¯¦ç»†çš„æ•°æ®è¿ç§»è®¡åˆ’ï¼Œç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§å’Œå®Œæ•´æ€§
5. **å¢é‡å‘å¸ƒ**ï¼šé‡‡ç”¨å¢é‡å‘å¸ƒçš„æ–¹å¼ï¼Œé€æ­¥å°†æ‹†åˆ†åçš„æœåŠ¡éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

## ä¸‰ã€å¾®æœåŠ¡æ¶æ„ç»„ä»¶

å¾®æœåŠ¡æ¶æ„ç”±å¤šä¸ªç»„ä»¶æ„æˆï¼Œè¿™äº›ç»„ä»¶ååŒå·¥ä½œï¼Œå…±åŒæ”¯æŒå¾®æœåŠ¡ç³»ç»Ÿçš„è¿è¡Œã€‚

### 3.1 æœåŠ¡æ³¨å†Œä¸å‘ç°

æœåŠ¡æ³¨å†Œä¸å‘ç°æ˜¯å¾®æœåŠ¡æ¶æ„ä¸­çš„å…³é”®ç»„ä»¶ï¼Œå®ƒè§£å†³äº†æœåŠ¡é—´é€šä¿¡çš„åœ°å€ç®¡ç†é—®é¢˜ã€‚

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- æœåŠ¡æ³¨å†Œï¼šæœåŠ¡å®ä¾‹å¯åŠ¨æ—¶å‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œè‡ªå·±çš„ä¿¡æ¯
- æœåŠ¡å‘ç°ï¼šå®¢æˆ·ç«¯ä»æ³¨å†Œä¸­å¿ƒè·å–æœåŠ¡å®ä¾‹çš„ä¿¡æ¯
- å¥åº·æ£€æŸ¥ï¼šç›‘æ§æœåŠ¡å®ä¾‹çš„å¥åº·çŠ¶æ€
- è´Ÿè½½å‡è¡¡ï¼šåœ¨å¤šä¸ªæœåŠ¡å®ä¾‹ä¹‹é—´è¿›è¡Œè´Ÿè½½å‡è¡¡

**å¸¸è§å®ç°**ï¼š
- **Eureka**ï¼šNetflixå¼€æºçš„æœåŠ¡å‘ç°æ¡†æ¶
- **Consul**ï¼šHashiCorpå¼€æºçš„æœåŠ¡å‘ç°å’Œé…ç½®å·¥å…·
- **Nacos**ï¼šé˜¿é‡Œå·´å·´å¼€æºçš„åŠ¨æ€æœåŠ¡å‘ç°ã€é…ç½®å’ŒæœåŠ¡ç®¡ç†å¹³å°
- **Zookeeper**ï¼šApacheå¼€æºçš„åˆ†å¸ƒå¼åè°ƒæœåŠ¡

**å®ç°ç¤ºä¾‹ï¼ˆSpring Cloud + Eurekaï¼‰**ï¼š

```java
// Eureka Serveré…ç½®
@SpringBootApplication
@EnableEurekaServer
public class EurekaServerApplication {
    public static void main(String[] args) {
        SpringApplication.run(EurekaServerApplication.class, args);
    }
}

// é…ç½®æ–‡ä»¶ application.yml
server:
  port: 8761

spring:
  application:
    name: eureka-server

eureka:
  client:
    registerWithEureka: false  # ä¸å‘è‡ªå·±æ³¨å†Œ
    fetchRegistry: false       # ä¸ä»è‡ªå·±è·å–æ³¨å†Œä¿¡æ¯
  server:
    waitTimeInMsWhenSyncEmpty: 0

// Eureka Clienté…ç½®
@SpringBootApplication
@EnableDiscoveryClient
public class ProductServiceApplication {
    public static void main(String[] args) {
        SpringApplication.run(ProductServiceApplication.class, args);
    }
    
    @RestController
    @RequestMapping("/products")
    public class ProductController {
        @GetMapping("/{id}")
        public Product getProduct(@PathVariable Long id) {
            // å®ç°å•†å“æŸ¥è¯¢é€»è¾‘
        }
    }
}

// é…ç½®æ–‡ä»¶ application.yml
server:
  port: 8080

spring:
  application:
    name: product-service

eureka:
  client:
    serviceUrl:
      defaultZone: http://localhost:8761/eureka/
```

### 3.2 APIç½‘å…³

APIç½‘å…³æ˜¯å¾®æœåŠ¡æ¶æ„ä¸­çš„é‡è¦ç»„ä»¶ï¼Œå®ƒä½œä¸ºç³»ç»Ÿçš„å”¯ä¸€å…¥å£ï¼Œè´Ÿè´£è¯·æ±‚è·¯ç”±ã€è´Ÿè½½å‡è¡¡ã€è®¤è¯æˆæƒã€é™æµç†”æ–­ç­‰åŠŸèƒ½ã€‚

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- è¯·æ±‚è·¯ç”±ï¼šæ ¹æ®è¯·æ±‚è·¯å¾„å°†è¯·æ±‚è½¬å‘åˆ°ç›¸åº”çš„æœåŠ¡
- è´Ÿè½½å‡è¡¡ï¼šåœ¨å¤šä¸ªæœåŠ¡å®ä¾‹ä¹‹é—´è¿›è¡Œè´Ÿè½½å‡è¡¡
- è®¤è¯æˆæƒï¼šå¯¹è¯·æ±‚è¿›è¡Œè®¤è¯å’Œæˆæƒæ£€æŸ¥
- é™æµç†”æ–­ï¼šå¯¹è¯·æ±‚è¿›è¡Œé™æµå’Œç†”æ–­å¤„ç†
- ç›‘æ§æ—¥å¿—ï¼šæ”¶é›†è¯·æ±‚çš„ç›‘æ§å’Œæ—¥å¿—ä¿¡æ¯
- åè®®è½¬æ¢ï¼šåœ¨ä¸åŒåè®®ä¹‹é—´è¿›è¡Œè½¬æ¢
- æ•°æ®è½¬æ¢ï¼šå¯¹è¯·æ±‚å’Œå“åº”æ•°æ®è¿›è¡Œè½¬æ¢

**å¸¸è§å®ç°**ï¼š
- **Spring Cloud Gateway**ï¼šSpring Cloudæä¾›çš„APIç½‘å…³
- **Netflix Zuul**ï¼šNetflixå¼€æºçš„APIç½‘å…³
- **Kong**ï¼šåŸºäºNginxçš„å¼€æºAPIç½‘å…³
- **Traefik**ï¼šå¼€æºçš„äº‘åŸç”Ÿåå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡å·¥å…·

**å®ç°ç¤ºä¾‹ï¼ˆSpring Cloud Gatewayï¼‰**ï¼š

```java
@SpringBootApplication
@EnableDiscoveryClient
public class GatewayApplication {
    public static void main(String[] args) {
        SpringApplication.run(GatewayApplication.class, args);
    }
    
    @Bean
    public RouteLocator customRouteLocator(RouteLocatorBuilder builder) {
        return builder.routes()
                .route("product_service_route", r -> r
                        .path("/api/products/**")
                        .filters(f -> f
                                .stripPrefix(1)
                                .circuitBreaker(c -> c.setName("productServiceCircuitBreaker"))
                                .requestRateLimiter(c -> c
                                        .setRateLimiter(redisRateLimiter())
                                        .setKeyResolver(userKeyResolver()))
                        )
                        .uri("lb://product-service"))
                .route("order_service_route", r -> r
                        .path("/api/orders/**")
                        .filters(f -> f
                                .stripPrefix(1)
                                .circuitBreaker(c -> c.setName("orderServiceCircuitBreaker"))
                        )
                        .uri("lb://order-service"))
                .build();
    }
    
    @Bean
    public RedisRateLimiter redisRateLimiter() {
        return new RedisRateLimiter(10, 20); // æ¯ç§’å…è®¸10ä¸ªè¯·æ±‚ï¼Œæœ€å¤§çªå‘20ä¸ª
    }
    
    @Bean
    public KeyResolver userKeyResolver() {
        return exchange -> Mono.just("user" + exchange.getRequest().getHeaders().getFirst("User-Id"));
    }
}

// é…ç½®æ–‡ä»¶ application.yml
server:
  port: 8080

spring:
  application:
    name: api-gateway
  cloud:
    gateway:
      discovery:
        locator:
          enabled: true
          lower-case-service-id: true
      routes:
        - id: product-service
          uri: lb://product-service
          predicates:
            - Path=/api/products/**
          filters:
            - StripPrefix=1
        - id: order-service
          uri: lb://order-service
          predicates:
            - Path=/api/orders/**
          filters:
            - StripPrefix=1

eureka:
  client:
    serviceUrl:
      defaultZone: http://localhost:8761/eureka/
```

### 3.3 é…ç½®ä¸­å¿ƒ

é…ç½®ä¸­å¿ƒæ˜¯é›†ä¸­ç®¡ç†å„ä¸ªç¯å¢ƒçš„é…ç½®æ–‡ä»¶çš„ç»„ä»¶ï¼Œå®ƒæ”¯æŒåŠ¨æ€é…ç½®æ›´æ–°ï¼Œæ— éœ€é‡å¯æœåŠ¡å³å¯ä½¿é…ç½®ç”Ÿæ•ˆã€‚

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- é›†ä¸­ç®¡ç†é…ç½®ï¼šå°†æ‰€æœ‰æœåŠ¡çš„é…ç½®é›†ä¸­å­˜å‚¨å’Œç®¡ç†
- åŠ¨æ€é…ç½®æ›´æ–°ï¼šæ”¯æŒåœ¨è¿è¡Œæ—¶æ›´æ–°é…ç½®ï¼Œæ— éœ€é‡å¯æœåŠ¡
- ç¯å¢ƒéš”ç¦»ï¼šä¸ºä¸åŒç¯å¢ƒï¼ˆå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ï¼‰æä¾›ä¸åŒçš„é…ç½®
- é…ç½®ç‰ˆæœ¬ç®¡ç†ï¼šè®°å½•é…ç½®çš„å˜æ›´å†å²ï¼Œæ”¯æŒå›æ»š
- æƒé™æ§åˆ¶ï¼šå¯¹é…ç½®çš„è®¿é—®å’Œä¿®æ”¹è¿›è¡Œæƒé™æ§åˆ¶

**å¸¸è§å®ç°**ï¼š
- **Spring Cloud Config**ï¼šSpring Cloudæä¾›çš„é…ç½®ç®¡ç†å·¥å…·
- **Nacos Config**ï¼šNacosæä¾›çš„é…ç½®ç®¡ç†åŠŸèƒ½
- **Apollo**ï¼šæºç¨‹å¼€æºçš„é…ç½®ä¸­å¿ƒ
- **Consul Config**ï¼šConsulæä¾›çš„é…ç½®ç®¡ç†åŠŸèƒ½

**å®ç°ç¤ºä¾‹ï¼ˆSpring Cloud Configï¼‰**ï¼š

```java
// Config Serveré…ç½®
@SpringBootApplication
@EnableConfigServer
public class ConfigServerApplication {
    public static void main(String[] args) {
        SpringApplication.run(ConfigServerApplication.class, args);
    }
}

// é…ç½®æ–‡ä»¶ application.yml
server:
  port: 8888

spring:
  application:
    name: config-server
  cloud:
    config:
      server:
        git:
          uri: https://github.com/example/config-repo
          searchPaths: '{application}'
          default-label: main

// Config Clienté…ç½®
@SpringBootApplication
@EnableDiscoveryClient
@RestController
public class ProductServiceApplication {
    @Value("${product.service.version}")
    private String version;
    
    @GetMapping("/version")
    public String getVersion() {
        return version;
    }
    
    public static void main(String[] args) {
        SpringApplication.run(ProductServiceApplication.class, args);
    }
}

// é…ç½®æ–‡ä»¶ bootstrap.yml
spring:
  application:
    name: product-service
  cloud:
    config:
      uri: http://localhost:8888
      fail-fast: true
      retry:
        max-attempts: 6
        initial-interval: 1000
        multiplier: 1.1

// åœ¨Gitä»“åº“ä¸­çš„é…ç½®æ–‡ä»¶ product-service.yml
product:
  service:
    version: 1.0.0
    timeout: 5000
    max-connections: 100
```

### 3.4 æœåŠ¡é€šä¿¡

å¾®æœåŠ¡æ¶æ„ä¸­çš„æœåŠ¡é—´é€šä¿¡æ˜¯ä¸€ä¸ªé‡è¦çš„è¯é¢˜ï¼Œä¸»è¦åŒ…æ‹¬åŒæ­¥é€šä¿¡å’Œå¼‚æ­¥é€šä¿¡ä¸¤ç§æ–¹å¼ã€‚

#### 3.4.1 åŒæ­¥é€šä¿¡

åŒæ­¥é€šä¿¡æ˜¯æŒ‡è°ƒç”¨æ–¹å‘é€è¯·æ±‚åï¼Œéœ€è¦ç­‰å¾…è¢«è°ƒç”¨æ–¹è¿”å›å“åº”æ‰èƒ½ç»§ç»­æ‰§è¡Œçš„é€šä¿¡æ–¹å¼ã€‚

**å¸¸è§å®ç°**ï¼š
- **REST API**ï¼šåŸºäºHTTPåè®®çš„RESTful API
- **gRPC**ï¼šGoogleå¼€æºçš„é«˜æ€§èƒ½RPCæ¡†æ¶
- **GraphQL**ï¼šFacebookå¼€æºçš„APIæŸ¥è¯¢è¯­è¨€

**å®ç°ç¤ºä¾‹ï¼ˆSpring Cloud OpenFeignï¼‰**ï¼š

```java
// è®¢å•æœåŠ¡è°ƒç”¨å•†å“æœåŠ¡
@FeignClient(name = "product-service", fallback = ProductServiceFallback.class)
public interface ProductServiceClient {
    @GetMapping("/products/{id}")
    Product getProductById(@PathVariable("id") Long id);
    
    @GetMapping("/products/{id}/stock")
    StockInfo getProductStock(@PathVariable("id") Long id);
}

// ç†”æ–­å™¨å®ç°
@Component
public class ProductServiceFallback implements ProductServiceClient {
    @Override
    public Product getProductById(Long id) {
        // è¿”å›é»˜è®¤å€¼æˆ–æŠ›å‡ºå¼‚å¸¸
        return new Product();
    }
    
    @Override
    public StockInfo getProductStock(Long id) {
        // è¿”å›é»˜è®¤å€¼æˆ–æŠ›å‡ºå¼‚å¸¸
        return new StockInfo();
    }
}

// åœ¨è®¢å•æœåŠ¡ä¸­ä½¿ç”¨
@Service
public class OrderService {
    @Autowired
    private ProductServiceClient productServiceClient;
    
    public Order createOrder(OrderRequest request) {
        // è°ƒç”¨å•†å“æœåŠ¡è·å–å•†å“ä¿¡æ¯
        Product product = productServiceClient.getProductById(request.getProductId());
        
        // è°ƒç”¨å•†å“æœåŠ¡æ£€æŸ¥åº“å­˜
        StockInfo stockInfo = productServiceClient.getProductStock(request.getProductId());
        if (stockInfo.getQuantity() < request.getQuantity()) {
            throw new InsufficientStockException("Insufficient stock for product: " + request.getProductId());
        }
        
        // åˆ›å»ºè®¢å•...
    }
}
```

#### 3.4.2 å¼‚æ­¥é€šä¿¡

å¼‚æ­¥é€šä¿¡æ˜¯æŒ‡è°ƒç”¨æ–¹å‘é€è¯·æ±‚åï¼Œä¸éœ€è¦ç­‰å¾…è¢«è°ƒç”¨æ–¹è¿”å›å“åº”å³å¯ç»§ç»­æ‰§è¡Œçš„é€šä¿¡æ–¹å¼ã€‚

**å¸¸è§å®ç°**ï¼š
- **æ¶ˆæ¯é˜Ÿåˆ—**ï¼šå¦‚Kafkaã€RabbitMQã€RocketMQç­‰
- **äº‹ä»¶é©±åŠ¨**ï¼šåŸºäºäº‹ä»¶çš„å‘å¸ƒ-è®¢é˜…æ¨¡å¼
- **æ¶ˆæ¯ä¸­é—´ä»¶**ï¼šå¦‚ActiveMQã€IBM MQç­‰

**å®ç°ç¤ºä¾‹ï¼ˆSpring Cloud Stream + Kafkaï¼‰**ï¼š

```java
// è®¢å•æœåŠ¡å‘é€æ¶ˆæ¯
@Service
public class OrderEventPublisher {
    @Autowired
    private KafkaTemplate<String, OrderEvent> kafkaTemplate;
    
    public void publishOrderCreatedEvent(Order order) {
        OrderEvent event = new OrderEvent();
        event.setOrderId(order.getId());
        event.setEventType("ORDER_CREATED");
        event.setPayload(order);
        event.setTimestamp(System.currentTimeMillis());
        
        kafkaTemplate.send("order-events", event);
    }
}

// åº“å­˜æœåŠ¡æ¥æ”¶æ¶ˆæ¯
@Service
public class InventoryEventHandler {
    @Autowired
    private InventoryService inventoryService;
    
    @KafkaListener(topics = "order-events", groupId = "inventory-group")
    public void handleOrderEvent(OrderEvent event) {
        if ("ORDER_CREATED".equals(event.getEventType())) {
            Order order = (Order) event.getPayload();
            // å¤„ç†è®¢å•åˆ›å»ºäº‹ä»¶ï¼Œå¦‚æ‰£å‡åº“å­˜
            inventoryService.reduceInventory(order.getProductId(), order.getQuantity());
        }
    }
}

// é…ç½®Kafka
@Configuration
@EnableKafka
public class KafkaConfig {
    @Bean
    public ProducerFactory<String, OrderEvent> producerFactory() {
        Map<String, Object> configProps = new HashMap<>();
        configProps.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:9092");
        configProps.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class);
        configProps.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, JsonSerializer.class);
        return new DefaultKafkaProducerFactory<>(configProps);
    }
    
    @Bean
    public KafkaTemplate<String, OrderEvent> kafkaTemplate() {
        return new KafkaTemplate<>(producerFactory());
    }
    
    @Bean
    public ConsumerFactory<String, OrderEvent> consumerFactory() {
        Map<String, Object> configProps = new HashMap<>();
        configProps.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:9092");
        configProps.put(ConsumerConfig.GROUP_ID_CONFIG, "inventory-group");
        configProps.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);
        configProps.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, JsonDeserializer.class);
        return new DefaultKafkaConsumerFactory<>(configProps, new StringDeserializer(),
                new JsonDeserializer<>(OrderEvent.class));
    }
}
```

### 3.5 æ–­è·¯å™¨å’Œç†”æ–­å™¨

æ–­è·¯å™¨å’Œç†”æ–­å™¨æ˜¯å¾®æœåŠ¡æ¶æ„ä¸­çš„é‡è¦å®¹é”™ç»„ä»¶ï¼Œå®ƒä»¬å¯ä»¥é˜²æ­¢æ•…éšœåœ¨æœåŠ¡é—´æ‰©æ•£ï¼Œæé«˜ç³»ç»Ÿçš„å¼¹æ€§ã€‚

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- **æ•…éšœéš”ç¦»**ï¼šå°†æ•…éšœé™åˆ¶åœ¨å•ä¸ªæœåŠ¡å†…ï¼Œé˜²æ­¢çº§è”æ•…éšœ
- **å¿«é€Ÿå¤±è´¥**ï¼šåœ¨æœåŠ¡ä¸å¯ç”¨æ—¶å¿«é€Ÿè¿”å›ï¼Œé¿å…é•¿æ—¶é—´ç­‰å¾…
- **è‡ªåŠ¨æ¢å¤**ï¼šåœ¨æœåŠ¡æ¢å¤æ­£å¸¸åè‡ªåŠ¨å…³é—­æ–­è·¯å™¨
- **é™çº§å¤„ç†**ï¼šåœ¨æœåŠ¡ä¸å¯ç”¨æ—¶æä¾›å¤‡ç”¨æ–¹æ¡ˆ

**å¸¸è§å®ç°**ï¼š
- **Spring Cloud Circuit Breaker**ï¼šSpring Cloudæä¾›çš„æ–­è·¯å™¨æŠ½è±¡
- **Resilience4j**ï¼šè½»é‡çº§çš„å®¹é”™åº“
- **Hystrix**ï¼šNetflixå¼€æºçš„æ–­è·¯å™¨åº“ï¼ˆå·²è¿›å…¥ç»´æŠ¤æ¨¡å¼ï¼‰
- **Sentinel**ï¼šé˜¿é‡Œå·´å·´å¼€æºçš„æµé‡æ§åˆ¶å’Œç†”æ–­é™çº§ç»„ä»¶

**å®ç°ç¤ºä¾‹ï¼ˆSpring Cloud Circuit Breaker + Resilience4jï¼‰**ï¼š

```java
@Service
public class ProductService {
    @Autowired
    private RestTemplate restTemplate;
    
    @CircuitBreaker(name = "productService", fallbackMethod = "getProductFallback")
    @RateLimiter(name = "productService")
    public Product getProduct(Long productId) {
        return restTemplate.getForObject("http://product-service/products/{id}", Product.class, productId);
    }
    
    public Product getProductFallback(Long productId, Exception e) {
        // é™çº§é€»è¾‘ï¼Œè¿”å›é»˜è®¤å€¼æˆ–ä»ç¼“å­˜è·å–
        Product defaultProduct = new Product();
        defaultProduct.setId(productId);
        defaultProduct.setName("Product not available");
        return defaultProduct;
    }
}

// é…ç½®æ–‡ä»¶ application.yml
resilience4j:
  circuitbreaker:
    instances:
      productService:
        slidingWindowSize: 10
        failureRateThreshold: 50
        waitDurationInOpenState: 5000
        permittedNumberOfCallsInHalfOpenState: 3
        registerHealthIndicator: true
  ratelimiter:
    instances:
      productService:
        limitForPeriod: 10
        limitRefreshPeriod: 1s
        timeoutDuration: 500ms
```

### 3.6 åˆ†å¸ƒå¼è¿½è¸ª

åˆ†å¸ƒå¼è¿½è¸ªæ˜¯å¾®æœåŠ¡æ¶æ„ä¸­çš„é‡è¦å¯è§‚æµ‹æ€§ç»„ä»¶ï¼Œå®ƒå¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜è·Ÿè¸ªè¯·æ±‚çš„å®Œæ•´è·¯å¾„ï¼Œå®šä½æ€§èƒ½ç“¶é¢ˆå’Œæ•…éšœã€‚

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- **è¯·æ±‚è·Ÿè¸ª**ï¼šè·Ÿè¸ªè¯·æ±‚åœ¨å¤šä¸ªæœåŠ¡é—´çš„æµè½¬è¿‡ç¨‹
- **æ€§èƒ½ç›‘æ§**ï¼šç›‘æ§æ¯ä¸ªæœåŠ¡çš„å“åº”æ—¶é—´å’Œå¤„ç†æ•ˆç‡
- **æ•…éšœå®šä½**ï¼šå¿«é€Ÿå®šä½è¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­çš„æ•…éšœç‚¹
- **ä¾èµ–åˆ†æ**ï¼šåˆ†ææœåŠ¡é—´çš„ä¾èµ–å…³ç³»å’Œè°ƒç”¨é“¾

**å¸¸è§å®ç°**ï¼š
- **Spring Cloud Sleuth + Zipkin**ï¼šSpring Cloudæä¾›çš„åˆ†å¸ƒå¼è¿½è¸ªè§£å†³æ–¹æ¡ˆ
- **Jaeger**ï¼šUberå¼€æºçš„åˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿ
- **SkyWalking**ï¼šå›½äº§å¼€æºçš„APMç³»ç»Ÿ
- **Pinpoint**ï¼šå¼€æºçš„APMå·¥å…·

**å®ç°ç¤ºä¾‹ï¼ˆSpring Cloud Sleuth + Zipkinï¼‰**ï¼š

```java
// åœ¨æ‰€æœ‰å¾®æœåŠ¡ä¸­æ·»åŠ ä»¥ä¸‹ä¾èµ–å’Œé…ç½®
@SpringBootApplication
@EnableDiscoveryClient
public class ProductServiceApplication {
    public static void main(String[] args) {
        SpringApplication.run(ProductServiceApplication.class, args);
    }
    
    @Bean
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
}

// é…ç½®æ–‡ä»¶ application.yml
spring:
  application:
    name: product-service
  sleuth:
    sampler:
      probability: 1.0  # é‡‡æ ·ç‡ï¼Œ1.0è¡¨ç¤ºå…¨éƒ¨é‡‡æ ·
  zipkin:
    base-url: http://localhost:9411/
    sender:
      type: web

eureka:
  client:
    serviceUrl:
      defaultZone: http://localhost:8761/eureka/

// Zipkin Serveré…ç½®ï¼ˆå•ç‹¬çš„æœåŠ¡ï¼‰
@SpringBootApplication
@EnableZipkinServer
public class ZipkinServerApplication {
    public static void main(String[] args) {
        SpringApplication.run(ZipkinServerApplication.class, args);
    }
}

// é…ç½®æ–‡ä»¶ application.yml
server:
  port: 9411

spring:
  application:
    name: zipkin-server
  sleuth:
    sampler:
      probability: 0  # ZipkinæœåŠ¡æœ¬èº«ä¸é‡‡æ ·
```

## å››ã€å¾®æœåŠ¡æ•°æ®ç®¡ç†

å¾®æœåŠ¡æ¶æ„ä¸­çš„æ•°æ®ç®¡ç†æ˜¯ä¸€ä¸ªå¤æ‚çš„é—®é¢˜ï¼Œéœ€è¦è€ƒè™‘æ•°æ®ä¸€è‡´æ€§ã€æ•°æ®éš”ç¦»ã€æ•°æ®æŸ¥è¯¢ç­‰å¤šä¸ªæ–¹é¢ã€‚

### 4.1 æ•°æ®éš”ç¦»ç­–ç•¥

åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œæ¯ä¸ªæœåŠ¡åº”è¯¥æ‹¥æœ‰è‡ªå·±çš„æ•°æ®å­˜å‚¨ï¼Œè¿™æœ‰åŠ©äºä¿æŒæœåŠ¡çš„ç‹¬ç«‹æ€§å’Œæ¾è€¦åˆã€‚

**æ•°æ®éš”ç¦»çš„æ–¹å¼**ï¼š
- **æ•°æ®åº“å®ä¾‹éš”ç¦»**ï¼šæ¯ä¸ªæœåŠ¡ä½¿ç”¨ç‹¬ç«‹çš„æ•°æ®åº“å®ä¾‹
- **æ•°æ®åº“ Schema éš”ç¦»**ï¼šå¤šä¸ªæœåŠ¡ä½¿ç”¨åŒä¸€ä¸ªæ•°æ®åº“å®ä¾‹ï¼Œä½†ä½¿ç”¨ä¸åŒçš„Schema
- **è¡¨å‰ç¼€éš”ç¦»**ï¼šå¤šä¸ªæœåŠ¡ä½¿ç”¨åŒä¸€ä¸ªæ•°æ®åº“å®ä¾‹å’ŒSchemaï¼Œä½†è¡¨åä½¿ç”¨ä¸åŒçš„å‰ç¼€
- **å¤šç§Ÿæˆ·éš”ç¦»**ï¼šé€šè¿‡ç§Ÿæˆ·IDåœ¨åŒä¸€ä¸ªæ•°æ®è¡¨ä¸­éš”ç¦»ä¸åŒæœåŠ¡çš„æ•°æ®

**ç¤ºä¾‹**ï¼šç”µå•†ç³»ç»Ÿçš„æ•°æ®éš”ç¦»

```
ç”µå•†ç³»ç»Ÿæ•°æ®éš”ç¦»
â”œâ”€â”€ ç”¨æˆ·æœåŠ¡
â”‚   â””â”€â”€ ç”¨æˆ·æ•°æ®åº“ï¼ˆç‹¬ç«‹çš„MySQLå®ä¾‹ï¼‰
â”œâ”€â”€ å•†å“æœåŠ¡
â”‚   â””â”€â”€ å•†å“æ•°æ®åº“ï¼ˆç‹¬ç«‹çš„MySQLå®ä¾‹ï¼‰
â”œâ”€â”€ è®¢å•æœåŠ¡
â”‚   â””â”€â”€ è®¢å•æ•°æ®åº“ï¼ˆç‹¬ç«‹çš„MySQLå®ä¾‹ï¼‰
â””â”€â”€ æ¨èæœåŠ¡
    â””â”€â”€ æ¨èæ•°æ®å­˜å‚¨ï¼ˆç‹¬ç«‹çš„MongoDBå®ä¾‹ï¼‰
```

### 4.2 åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†

åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œä¼ ç»Ÿçš„ACIDäº‹åŠ¡éš¾ä»¥æ»¡è¶³éœ€æ±‚ï¼Œéœ€è¦é‡‡ç”¨æ–°çš„åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†ç­–ç•¥ã€‚

**å¸¸è§çš„åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†ç­–ç•¥**ï¼š

#### 4.2.1 ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰

ä¸¤é˜¶æ®µæäº¤æ˜¯ä¸€ç§å¼ºä¸€è‡´æ€§çš„åˆ†å¸ƒå¼äº‹åŠ¡åè®®ï¼ŒåŒ…æ‹¬å‡†å¤‡é˜¶æ®µå’Œæäº¤é˜¶æ®µä¸¤ä¸ªé˜¶æ®µã€‚

**ä¼˜ç‚¹**ï¼š
- ä¿è¯æ•°æ®çš„å¼ºä¸€è‡´æ€§

**ç¼ºç‚¹**ï¼š
- æ€§èƒ½è¾ƒå·®ï¼Œåè°ƒè€…æˆä¸ºç“¶é¢ˆ
- å­˜åœ¨é˜»å¡é—®é¢˜ï¼Œåœ¨å‡†å¤‡é˜¶æ®µåå¦‚æœåè°ƒè€…æ•…éšœï¼Œå‚ä¸è€…ä¼šä¸€ç›´é˜»å¡
- ä¸é€‚åˆé«˜å¹¶å‘åœºæ™¯

**å®ç°ç¤ºä¾‹ï¼ˆAtomikosï¼‰**ï¼š

```java
@Configuration
@EnableTransactionManagement
public class TransactionConfig {
    @Bean
    public UserTransactionManager userTransactionManager() throws SystemException {
        UserTransactionManager manager = new UserTransactionManager();
        manager.setForceShutdown(false);
        return manager;
    }
    
    @Bean
    public UserTransaction userTransaction() throws SystemException {
        UserTransactionImp userTransactionImp = new UserTransactionImp();
        userTransactionImp.setTransactionTimeout(10000);
        return userTransactionImp;
    }
    
    @Bean
    public PlatformTransactionManager transactionManager() throws SystemException {
        JtaTransactionManager manager = new JtaTransactionManager();
        manager.setTransactionManager(userTransactionManager());
        manager.setUserTransaction(userTransaction());
        return manager;
    }
}

@Service
public class OrderService {
    @Autowired
    private OrderRepository orderRepository;
    @Autowired
    private ProductClient productClient;
    
    @Transactional
    public Order createOrder(OrderRequest request) {
        // åˆ›å»ºè®¢å•
        Order order = new Order();
        order.setProductId(request.getProductId());
        order.setQuantity(request.getQuantity());
        order.setStatus(OrderStatus.CREATED);
        orderRepository.save(order);
        
        // è°ƒç”¨å•†å“æœåŠ¡æ‰£å‡åº“å­˜
        productClient.reduceInventory(request.getProductId(), request.getQuantity());
        
        return order;
    }
}
```

#### 4.2.2 è¡¥å¿äº‹åŠ¡ï¼ˆTCCï¼‰

TCCï¼ˆTry-Confirm-Cancelï¼‰æ˜¯ä¸€ç§åŸºäºä¸šåŠ¡å±‚é¢çš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼ŒåŒ…æ‹¬å°è¯•ã€ç¡®è®¤å’Œå–æ¶ˆä¸‰ä¸ªé˜¶æ®µã€‚

**ä¼˜ç‚¹**ï¼š
- æ€§èƒ½è¾ƒå¥½ï¼Œä¸éœ€è¦é”èµ„æº
- å¯ä»¥æ ¹æ®ä¸šåŠ¡åœºæ™¯å®šåˆ¶åŒ–å®ç°
- é€‚ç”¨äºé«˜å¹¶å‘åœºæ™¯

**ç¼ºç‚¹**ï¼š
- å®ç°å¤æ‚åº¦é«˜ï¼Œéœ€è¦ä¸šåŠ¡å±‚é…åˆ
- éœ€è¦å¤„ç†å¹‚ç­‰æ€§é—®é¢˜
- è¡¥å¿æ“ä½œå¯èƒ½å¤±è´¥

**å®ç°ç¤ºä¾‹**ï¼š

```java
public interface InventoryTccService {
    // Tryé˜¶æ®µï¼šå†»ç»“åº“å­˜
    @TwoPhaseBusinessAction(name = "reduceInventory", commitMethod = "confirmReduceInventory", rollbackMethod = "cancelReduceInventory")
    void prepareReduceInventory(@BusinessActionContextParameter(paramName = "productId") Long productId,
                                @BusinessActionContextParameter(paramName = "quantity") Integer quantity);
    
    // Confirmé˜¶æ®µï¼šç¡®è®¤æ‰£å‡åº“å­˜
    void confirmReduceInventory(BusinessActionContext context);
    
    // Cancelé˜¶æ®µï¼šå–æ¶ˆæ‰£å‡åº“å­˜
    void cancelReduceInventory(BusinessActionContext context);
}

@Service
public class InventoryTccServiceImpl implements InventoryTccService {
    @Autowired
    private InventoryRepository inventoryRepository;
    
    @Override
    public void prepareReduceInventory(Long productId, Integer quantity) {
        // æ£€æŸ¥åº“å­˜
        Inventory inventory = inventoryRepository.findByProductId(productId);
        if (inventory == null || inventory.getAvailableQuantity() < quantity) {
            throw new InsufficientInventoryException("Insufficient inventory");
        }
        
        // å†»ç»“åº“å­˜
        inventory.setAvailableQuantity(inventory.getAvailableQuantity() - quantity);
        inventory.setFrozenQuantity(inventory.getFrozenQuantity() + quantity);
        inventoryRepository.save(inventory);
    }
    
    @Override
    public void confirmReduceInventory(BusinessActionContext context) {
        // ç¡®è®¤æ‰£å‡åº“å­˜
        Long productId = Long.valueOf(context.getActionContext("productId").toString());
        Integer quantity = Integer.valueOf(context.getActionContext("quantity").toString());
        
        Inventory inventory = inventoryRepository.findByProductId(productId);
        inventory.setFrozenQuantity(inventory.getFrozenQuantity() - quantity);
        inventoryRepository.save(inventory);
    }
    
    @Override
    public void cancelReduceInventory(BusinessActionContext context) {
        // å–æ¶ˆæ‰£å‡åº“å­˜
        Long productId = Long.valueOf(context.getActionContext("productId").toString());
        Integer quantity = Integer.valueOf(context.getActionContext("quantity").toString());
        
        Inventory inventory = inventoryRepository.findByProductId(productId);
        inventory.setAvailableQuantity(inventory.getAvailableQuantity() + quantity);
        inventory.setFrozenQuantity(inventory.getFrozenQuantity() - quantity);
        inventoryRepository.save(inventory);
    }
}

@Service
public class OrderService {
    @Autowired
    private OrderRepository orderRepository;
    @Autowired
    private InventoryTccService inventoryTccService;
    
    @Transactional
    public Order createOrder(OrderRequest request) {
        // åˆ›å»ºè®¢å•
        Order order = new Order();
        order.setProductId(request.getProductId());
        order.setQuantity(request.getQuantity());
        order.setStatus(OrderStatus.CREATED);
        orderRepository.save(order);
        
        // è°ƒç”¨TCCæœåŠ¡å†»ç»“åº“å­˜
        inventoryTccService.prepareReduceInventory(request.getProductId(), request.getQuantity());
        
        return order;
    }
}
```

#### 4.2.3 æœ€ç»ˆä¸€è‡´æ€§

æœ€ç»ˆä¸€è‡´æ€§æ˜¯ä¸€ç§å¼±ä¸€è‡´æ€§ç­–ç•¥ï¼Œå…è®¸ç³»ç»Ÿåœ¨ä¸€æ®µæ—¶é—´å†…å¤„äºä¸ä¸€è‡´çŠ¶æ€ï¼Œä½†æœ€ç»ˆä¼šè¾¾åˆ°ä¸€è‡´çŠ¶æ€ã€‚

**ä¼˜ç‚¹**ï¼š
- æ€§èƒ½å¥½ï¼Œç³»ç»Ÿååé‡é«˜
- ç³»ç»Ÿå¯ç”¨æ€§é«˜ï¼Œä¸ä¼šå› ä¸ºå•ç‚¹æ•…éšœè€Œé˜»å¡
- é€‚åˆå¤§è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿ

**ç¼ºç‚¹**ï¼š
- æ•°æ®å­˜åœ¨çŸ­æš‚çš„ä¸ä¸€è‡´çŠ¶æ€
- éœ€è¦å¤„ç†å¹¶å‘å’Œå¹‚ç­‰æ€§é—®é¢˜
- å®ç°å¤æ‚åº¦è¾ƒé«˜

**å®ç°ç¤ºä¾‹ï¼ˆåŸºäºæ¶ˆæ¯é˜Ÿåˆ—çš„æœ€ç»ˆä¸€è‡´æ€§ï¼‰**ï¼š

```java
@Service
public class OrderService {
    @Autowired
    private OrderRepository orderRepository;
    @Autowired
    private KafkaTemplate<String, OrderEvent> kafkaTemplate;
    
    @Transactional
    public Order createOrder(OrderRequest request) {
        // 1. åˆ›å»ºè®¢å•ï¼ˆå¾…æ”¯ä»˜çŠ¶æ€ï¼‰
        Order order = new Order();
        order.setProductId(request.getProductId());
        order.setQuantity(request.getQuantity());
        order.setStatus(OrderStatus.PENDING_PAYMENT);
        orderRepository.save(order);
        
        // 2. å‘é€è®¢å•åˆ›å»ºäº‹ä»¶
        OrderEvent event = new OrderEvent();
        event.setOrderId(order.getId());
        event.setEventType("ORDER_CREATED");
        event.setPayload(order);
        kafkaTemplate.send("order-events", event);
        
        return order;
    }
    
    @Transactional
    public void confirmPayment(Long orderId) {
        // 1. æ›´æ–°è®¢å•çŠ¶æ€ä¸ºå·²æ”¯ä»˜
        Order order = orderRepository.findById(orderId)
                .orElseThrow(() -> new OrderNotFoundException("Order not found: " + orderId));
        order.setStatus(OrderStatus.PAID);
        orderRepository.save(order);
        
        // 2. å‘é€è®¢å•æ”¯ä»˜äº‹ä»¶
        OrderEvent event = new OrderEvent();
        event.setOrderId(order.getId());
        event.setEventType("ORDER_PAID");
        event.setPayload(order);
        kafkaTemplate.send("order-events", event);
    }
}

@Service
public class InventoryService {
    @Autowired
    private InventoryRepository inventoryRepository;
    
    @KafkaListener(topics = "order-events", groupId = "inventory-group")
    public void handleOrderEvent(OrderEvent event) {
        if ("ORDER_PAID".equals(event.getEventType())) {
            Order order = (Order) event.getPayload();
            // æ‰£å‡åº“å­˜
            reduceInventory(order.getProductId(), order.getQuantity());
        }
    }
    
    @Transactional
    public void reduceInventory(Long productId, Integer quantity) {
        Inventory inventory = inventoryRepository.findByProductId(productId);
        if (inventory == null) {
            throw new InventoryNotFoundException("Inventory not found for product: " + productId);
        }
        
        if (inventory.getQuantity() < quantity) {
            throw new InsufficientInventoryException("Insufficient inventory for product: " + productId);
        }
        
        inventory.setQuantity(inventory.getQuantity() - quantity);
        inventoryRepository.save(inventory);
    }
}
```

### 4.3 æ•°æ®æŸ¥è¯¢ç­–ç•¥

åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œç”±äºæ•°æ®åˆ†æ•£åœ¨å¤šä¸ªæœåŠ¡ä¸­ï¼Œæ•°æ®æŸ¥è¯¢æˆä¸ºä¸€ä¸ªæŒ‘æˆ˜ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„æ•°æ®æŸ¥è¯¢ç­–ç•¥ï¼š

#### 4.3.1 APIç»„åˆæ¨¡å¼

APIç»„åˆæ¨¡å¼æ˜¯æŒ‡é€šè¿‡è°ƒç”¨å¤šä¸ªæœåŠ¡çš„APIï¼Œå°†ç»“æœç»„åˆèµ·æ¥è¿”å›ç»™å®¢æˆ·ç«¯ã€‚

**ä¼˜ç‚¹**ï¼š
- å®ç°ç®€å•ï¼Œä¸éœ€è¦é¢å¤–çš„æ•°æ®å­˜å‚¨
- æ•°æ®å®æ—¶æ€§å¥½

**ç¼ºç‚¹**ï¼š
- æ€§èƒ½è¾ƒå·®ï¼Œéœ€è¦å¤šæ¬¡ç½‘ç»œè°ƒç”¨
- å®¹æ˜“å‡ºç°çº§è”æ•…éšœ
- æ•°æ®ä¸€è‡´æ€§éš¾ä»¥ä¿è¯

**å®ç°ç¤ºä¾‹**ï¼š

```java
@RestController
@RequestMapping("/api/orders")
public class OrderController {
    @Autowired
    private OrderService orderService;
    @Autowired
    private ProductServiceClient productClient;
    @Autowired
    private UserServiceClient userClient;
    
    @GetMapping("/{id}")
    public OrderDTO getOrder(@PathVariable Long id) {
        // 1. è·å–è®¢å•åŸºæœ¬ä¿¡æ¯
        Order order = orderService.findById(id);
        
        // 2. è·å–å•†å“ä¿¡æ¯
        Product product = productClient.getProduct(order.getProductId());
        
        // 3. è·å–ç”¨æˆ·ä¿¡æ¯
        User user = userClient.getUser(order.getUserId());
        
        // 4. ç»„åˆæ•°æ®å¹¶è¿”å›
        OrderDTO dto = new OrderDTO();
        dto.setId(order.getId());
        dto.setProductName(product.getName());
        dto.setUserName(user.getName());
        dto.setQuantity(order.getQuantity());
        dto.setTotalAmount(order.getTotalAmount());
        dto.setStatus(order.getStatus());
        
        return dto;
    }
}
```

#### 4.3.2 CQRSæ¨¡å¼

CQRSï¼ˆCommand Query Responsibility Segregationï¼‰æ¨¡å¼æ˜¯æŒ‡å°†å‘½ä»¤ï¼ˆå†™æ“ä½œï¼‰å’ŒæŸ¥è¯¢ï¼ˆè¯»æ“ä½œï¼‰åˆ†ç¦»ï¼Œä½¿ç”¨ä¸åŒçš„æ¨¡å‹å’Œå­˜å‚¨ã€‚

**ä¼˜ç‚¹**ï¼š
- è¯»å†™åˆ†ç¦»ï¼Œä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
- å¯ä»¥é’ˆå¯¹è¯»æ“ä½œè¿›è¡Œä¸“é—¨ä¼˜åŒ–
- æé«˜ç³»ç»Ÿçš„å¯æ‰©å±•æ€§

**ç¼ºç‚¹**ï¼š
- å®ç°å¤æ‚åº¦é«˜
- æ•°æ®å­˜åœ¨å»¶è¿Ÿ
- éœ€è¦ç»´æŠ¤å¤šä¸ªæ•°æ®æ¨¡å‹

**å®ç°ç¤ºä¾‹**ï¼š

```java
// å‘½ä»¤æ¨¡å‹ï¼ˆå†™æ“ä½œï¼‰
@Service
public class OrderCommandService {
    @Autowired
    private OrderRepository orderRepository;
    @Autowired
    private OrderEventPublisher eventPublisher;
    
    @Transactional
    public void createOrder(CreateOrderCommand command) {
        // åˆ›å»ºè®¢å•
        Order order = new Order();
        order.setProductId(command.getProductId());
        order.setQuantity(command.getQuantity());
        order.setStatus(OrderStatus.CREATED);
        orderRepository.save(order);
        
        // å‘å¸ƒäº‹ä»¶
        eventPublisher.publish(new OrderCreatedEvent(order));
    }
    
    @Transactional
    public void updateOrderStatus(Long orderId, OrderStatus status) {
        Order order = orderRepository.findById(orderId)
                .orElseThrow(() -> new OrderNotFoundException("Order not found: " + orderId));
        
        order.setStatus(status);
        orderRepository.save(order);
        
        // å‘å¸ƒäº‹ä»¶
        eventPublisher.publish(new OrderStatusChangedEvent(order));
    }
}

// æŸ¥è¯¢æ¨¡å‹ï¼ˆè¯»æ“ä½œï¼‰
@Service
public class OrderQueryService {
    @Autowired
    private OrderReadRepository orderReadRepository;
    
    public OrderDTO getOrderById(Long id) {
        return orderReadRepository.findById(id)
                .orElseThrow(() -> new OrderNotFoundException("Order not found: " + id));
    }
    
    public List<OrderDTO> getOrdersByUserId(Long userId) {
        return orderReadRepository.findByUserId(userId);
    }
    
    public Page<OrderDTO> searchOrders(OrderSearchCriteria criteria, Pageable pageable) {
        return orderReadRepository.search(criteria, pageable);
    }
}

// äº‹ä»¶å¤„ç†å™¨ï¼Œæ›´æ–°æŸ¥è¯¢æ¨¡å‹
@Service
public class OrderEventProcessor {
    @Autowired
    private OrderReadRepository orderReadRepository;
    @Autowired
    private ProductServiceClient productClient;
    @Autowired
    private UserServiceClient userClient;
    
    @KafkaListener(topics = "order-events", groupId = "query-group")
    public void processOrderEvent(OrderEvent event) {
        if (event instanceof OrderCreatedEvent) {
            Order order = ((OrderCreatedEvent) event).getOrder();
            // æŸ¥è¯¢å•†å“å’Œç”¨æˆ·ä¿¡æ¯
            Product product = productClient.getProduct(order.getProductId());
            User user = userClient.getUser(order.getUserId());
            
            // åˆ›å»ºåªè¯»æ¨¡å‹
            OrderDTO dto = new OrderDTO();
            dto.setId(order.getId());
            dto.setProductId(order.getProductId());
            dto.setProductName(product.getName());
            dto.setUserId(order.getUserId());
            dto.setUserName(user.getName());
            dto.setQuantity(order.getQuantity());
            dto.setTotalAmount(order.getTotalAmount());
            dto.setStatus(order.getStatus());
            
            orderReadRepository.save(dto);
        } else if (event instanceof OrderStatusChangedEvent) {
            Order order = ((OrderStatusChangedEvent) event).getOrder();
            // æ›´æ–°åªè¯»æ¨¡å‹çš„çŠ¶æ€
            OrderDTO dto = orderReadRepository.findById(order.getId())
                    .orElseThrow(() -> new OrderNotFoundException("Order not found: " + order.getId()));
            
            dto.setStatus(order.getStatus());
            orderReadRepository.save(dto);
        }
    }
}
```

#### 4.3.3 æ•°æ®æ¹–/æ•°æ®ä»“åº“

æ•°æ®æ¹–æˆ–æ•°æ®ä»“åº“æ˜¯æŒ‡å°†å¤šä¸ªæœåŠ¡çš„æ•°æ®é›†æˆåˆ°ä¸€ä¸ªç»Ÿä¸€çš„æ•°æ®å­˜å‚¨ä¸­ï¼Œç”¨äºæ•°æ®åˆ†æå’ŒæŠ¥è¡¨ã€‚

**ä¼˜ç‚¹**ï¼š
- æä¾›ç»Ÿä¸€çš„æ•°æ®è§†å›¾
- ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
- æ”¯æŒå¤æ‚çš„æ•°æ®åˆ†æ

**ç¼ºç‚¹**ï¼š
- æ•°æ®å­˜åœ¨å»¶è¿Ÿ
- å®ç°å¤æ‚åº¦é«˜
- éœ€è¦é¢å¤–çš„å­˜å‚¨å’ŒETLå·¥å…·

**å®ç°ç¤ºä¾‹**ï¼š

```java
// ä½¿ç”¨Apache Sparkè¿›è¡ŒETLå¤„ç†
public class OrderDataWarehouseJob {
    public static void main(String[] args) {
        SparkSession spark = SparkSession.builder()
                .appName("OrderDataWarehouseJob")
                .master("local[*]")
                .getOrCreate();
        
        // ä»è®¢å•æ•°æ®åº“è¯»å–æ•°æ®
        Dataset<Row> orderDF = spark.read()
                .format("jdbc")
                .option("url", "jdbc:mysql://localhost:3306/order_db")
                .option("dbtable", "orders")
                .option("user", "root")
                .option("password", "password")
                .load();
        
        // ä»å•†å“æ•°æ®åº“è¯»å–æ•°æ®
        Dataset<Row> productDF = spark.read()
                .format("jdbc")
                .option("url", "jdbc:mysql://localhost:3306/product_db")
                .option("dbtable", "products")
                .option("user", "root")
                .option("password", "password")
                .load();
        
        // ä»ç”¨æˆ·æ•°æ®åº“è¯»å–æ•°æ®
        Dataset<Row> userDF = spark.read()
                .format("jdbc")
                .option("url", "jdbc:mysql://localhost:3306/user_db")
                .option("dbtable", "users")
                .option("user", "root")
                .option("password", "password")
                .load();
        
        // æ•°æ®å…³è”
        Dataset<Row> orderWithProductDF = orderDF.join(productDF, orderDF.col("product_id").equalTo(productDF.col("id")));
        Dataset<Row> orderWithUserAndProductDF = orderWithProductDF.join(userDF, orderWithProductDF.col("user_id").equalTo(userDF.col("id")));
        
        // æ•°æ®è½¬æ¢å’Œæ¸…æ´—
        Dataset<Row> factTableDF = orderWithUserAndProductDF.select(
                orderDF.col("id").alias("order_id"),
                userDF.col("id").alias("user_id"),
                userDF.col("name").alias("user_name"),
                productDF.col("id").alias("product_id"),
                productDF.col("name").alias("product_name"),
                orderDF.col("quantity"),
                orderDF.col("total_amount"),
                orderDF.col("status"),
                orderDF.col("create_time")
        );
        
        // å†™å…¥æ•°æ®ä»“åº“
        factTableDF.write()
                .format("parquet")
                .mode(SaveMode.Append)
                .saveAsTable("dw.order_fact");
        
        spark.stop();
    }
}
```

## äº”ã€å¾®æœåŠ¡éƒ¨ç½²ä¸è¿ç»´

å¾®æœåŠ¡æ¶æ„çš„éƒ¨ç½²å’Œè¿ç»´æ˜¯ä¸€ä¸ªå¤æ‚çš„é—®é¢˜ï¼Œéœ€è¦è€ƒè™‘æœåŠ¡ç¼–æ’ã€å®¹å™¨åŒ–ã€CI/CDç­‰å¤šä¸ªæ–¹é¢ã€‚

### 5.1 å®¹å™¨åŒ–

å®¹å™¨åŒ–æ˜¯å¾®æœåŠ¡æ¶æ„ä¸­çš„é‡è¦æŠ€æœ¯ï¼Œå®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´é«˜æ•ˆåœ°éƒ¨ç½²å’Œç®¡ç†æœåŠ¡ã€‚

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- **ç¯å¢ƒä¸€è‡´æ€§**ï¼šç¡®ä¿å¼€å‘ã€æµ‹è¯•å’Œç”Ÿäº§ç¯å¢ƒçš„ä¸€è‡´æ€§
- **è½»é‡çº§**ï¼šå®¹å™¨æ¯”è™šæ‹Ÿæœºæ›´è½»é‡çº§ï¼Œå¯åŠ¨æ›´å¿«
- **èµ„æºéš”ç¦»**ï¼šå®¹å™¨ä¹‹é—´ç›¸äº’éš”ç¦»ï¼Œé¿å…èµ„æºç«äº‰
- **å¿«é€Ÿéƒ¨ç½²**ï¼šå®¹å™¨å¯ä»¥å¿«é€Ÿå¯åŠ¨å’Œåœæ­¢ï¼Œæ”¯æŒå¿«é€Ÿéƒ¨ç½²
- **ç‰ˆæœ¬æ§åˆ¶**ï¼šå®¹å™¨é•œåƒæ”¯æŒç‰ˆæœ¬æ§åˆ¶ï¼Œä¾¿äºå›æ»š

**å¸¸è§å®ç°**ï¼š
- **Docker**ï¼šæœ€æµè¡Œçš„å®¹å™¨åŒ–å¹³å°
- **Kubernetes**ï¼šå®¹å™¨ç¼–æ’å¹³å°
- **Docker Compose**ï¼šç”¨äºå®šä¹‰å’Œè¿è¡Œå¤šå®¹å™¨Dockeråº”ç”¨ç¨‹åºçš„å·¥å…·

**Dockerfileç¤ºä¾‹**ï¼š

```dockerfile
# ä½¿ç”¨å®˜æ–¹çš„Javaè¿è¡Œæ—¶ä½œä¸ºåŸºç¡€é•œåƒ
FROM openjdk:11-jre-slim

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶JARæ–‡ä»¶åˆ°å®¹å™¨ä¸­
COPY target/product-service-1.0.0.jar app.jar

# æ·»åŠ ç¯å¢ƒå˜é‡
ENV JAVA_OPTS="-Xms256m -Xmx512m"

# æš´éœ²ç«¯å£
EXPOSE 8080

# è¿è¡Œåº”ç”¨
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]
```

**Docker Composeç¤ºä¾‹**ï¼š

```yaml
version: '3'

services:
  eureka-server:
    build: ./eureka-server
    ports:
      - "8761:8761"
    environment:
      - SPRING_PROFILES_ACTIVE=dev
    networks:
      - microservice-network

  config-server:
    build: ./config-server
    ports:
      - "8888:8888"
    depends_on:
      - eureka-server
    environment:
      - SPRING_PROFILES_ACTIVE=dev
    networks:
      - microservice-network

  api-gateway:
    build: ./api-gateway
    ports:
      - "8080:8080"
    depends_on:
      - eureka-server
      - config-server
    environment:
      - SPRING_PROFILES_ACTIVE=dev
    networks:
      - microservice-network

  product-service:
    build: ./product-service
    depends_on:
      - eureka-server
      - config-server
      - api-gateway
      - product-db
    environment:
      - SPRING_PROFILES_ACTIVE=dev
    networks:
      - microservice-network

  order-service:
    build: ./order-service
    depends_on:
      - eureka-server
      - config-server
      - api-gateway
      - order-db
    environment:
      - SPRING_PROFILES_ACTIVE=dev
    networks:
      - microservice-network

  product-db:
    image: mysql:8.0
    ports:
      - "3306:3306"
    environment:
      - MYSQL_DATABASE=product_db
      - MYSQL_USER=user
      - MYSQL_PASSWORD=password
      - MYSQL_ROOT_PASSWORD=root_password
    volumes:
      - product-db-data:/var/lib/mysql
    networks:
      - microservice-network

  order-db:
    image: mysql:8.0
    ports:
      - "3307:3306"
    environment:
      - MYSQL_DATABASE=order_db
      - MYSQL_USER=user
      - MYSQL_PASSWORD=password
      - MYSQL_ROOT_PASSWORD=root_password
    volumes:
      - order-db-data:/var/lib/mysql
    networks:
      - microservice-network

networks:
  microservice-network:
    driver: bridge

volumes:
  product-db-data:
  order-db-data:
```

### 5.2 æœåŠ¡ç¼–æ’ä¸è°ƒåº¦

æœåŠ¡ç¼–æ’ä¸è°ƒåº¦æ˜¯æŒ‡ç®¡ç†å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸã€æ‰©å±•ã€è´Ÿè½½å‡è¡¡ç­‰æ“ä½œçš„è¿‡ç¨‹ã€‚

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- **å®¹å™¨ç¼–æ’**ï¼šç®¡ç†å®¹å™¨çš„åˆ›å»ºã€å¯åŠ¨ã€åœæ­¢å’Œåˆ é™¤
- **æœåŠ¡å‘ç°**ï¼šè‡ªåŠ¨å‘ç°å’Œæ³¨å†ŒæœåŠ¡
- **è´Ÿè½½å‡è¡¡**ï¼šåœ¨å¤šä¸ªå®¹å™¨å®ä¾‹ä¹‹é—´è¿›è¡Œè´Ÿè½½å‡è¡¡
- **è‡ªåŠ¨æ‰©å±•**ï¼šæ ¹æ®è´Ÿè½½è‡ªåŠ¨æ‰©å±•æˆ–æ”¶ç¼©æœåŠ¡å®ä¾‹æ•°é‡
- **å¥åº·æ£€æŸ¥**ï¼šç›‘æ§å®¹å™¨çš„å¥åº·çŠ¶æ€
- **æ»šåŠ¨æ›´æ–°**ï¼šæ”¯æŒä¸ä¸­æ–­æœåŠ¡çš„æƒ…å†µä¸‹æ›´æ–°å®¹å™¨

**å¸¸è§å®ç°**ï¼š
- **Kubernetes**ï¼šæœ€æµè¡Œçš„å®¹å™¨ç¼–æ’å¹³å°
- **Docker Swarm**ï¼šDockeråŸç”Ÿçš„å®¹å™¨ç¼–æ’å·¥å…·
- **Apache Mesos**ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿå†…æ ¸

**Kubernetes Deploymentç¤ºä¾‹**ï¼š

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: product-service
  labels:
    app: product-service
spec:
  replicas: 3
  selector:
    matchLabels:
      app: product-service
  template:
    metadata:
      labels:
        app: product-service
    spec:
      containers:
      - name: product-service
        image: product-service:1.0.0
        ports:
        - containerPort: 8080
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /actuator/health/liveness
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 5
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "prod"
        - name: SPRING_CLOUD_CONFIG_URI
          value: "http://config-server:8888"
        - name: EUREKA_CLIENT_SERVICEURL_DEFAULTZONE
          value: "http://eureka-server:8761/eureka/"
```

**Kubernetes Serviceç¤ºä¾‹**ï¼š

```yaml
apiVersion: v1
kind: Service
metadata:
  name: product-service
  labels:
    app: product-service
spec:
  type: ClusterIP
  selector:
    app: product-service
  ports:
  - port: 8080
    targetPort: 8080
    protocol: TCP
```

### 5.3 CI/CDæµæ°´çº¿

CI/CDï¼ˆæŒç»­é›†æˆ/æŒç»­éƒ¨ç½²ï¼‰æµæ°´çº¿æ˜¯å¾®æœåŠ¡æ¶æ„ä¸­çš„é‡è¦å®è·µï¼Œå®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬è‡ªåŠ¨åŒ–æ„å»ºã€æµ‹è¯•å’Œéƒ¨ç½²è¿‡ç¨‹ã€‚

**æ ¸å¿ƒæµç¨‹**ï¼š
- **ä»£ç æäº¤**ï¼šå¼€å‘äººå‘˜æäº¤ä»£ç åˆ°ä»£ç ä»“åº“
- **æŒç»­é›†æˆ**ï¼šè‡ªåŠ¨æ„å»ºã€æµ‹è¯•å’ŒéªŒè¯ä»£ç 
- **æŒç»­éƒ¨ç½²**ï¼šè‡ªåŠ¨éƒ¨ç½²åˆ°æµ‹è¯•ã€é¢„å‘å¸ƒæˆ–ç”Ÿäº§ç¯å¢ƒ
- **ç›‘æ§åé¦ˆ**ï¼šç›‘æ§åº”ç”¨è¿è¡ŒçŠ¶æ€ï¼Œæä¾›åé¦ˆ

**å¸¸è§å®ç°**ï¼š
- **Jenkins**ï¼šæœ€æµè¡Œçš„CI/CDå·¥å…·
- **GitLab CI/CD**ï¼šGitLabå†…ç½®çš„CI/CDå·¥å…·
- **GitHub Actions**ï¼šGitHubæä¾›çš„CI/CDæœåŠ¡
- **CircleCI**ï¼šäº‘åŸç”Ÿçš„CI/CDå¹³å°
- **Travis CI**ï¼šæŒç»­é›†æˆæœåŠ¡

**Jenkins Pipelineç¤ºä¾‹**ï¼š

```groovy
pipeline {
    agent any
    
    environment {
        DOCKER_REPO = 'dockerhub.example.com'
        APP_NAME = 'product-service'
        VERSION = "${BUILD_NUMBER}"
    }
    
    stages {
        stage('Build') {
            steps {
                echo 'Building the application...'
                sh 'mvn clean package -DskipTests'
            }
        }
        
        stage('Test') {
            steps {
                echo 'Running unit tests...'
                sh 'mvn test'
                
                echo 'Running integration tests...'
                sh 'mvn verify -DskipUnitTests'
            }
        }
        
        stage('Code Quality') {
            steps {
                echo 'Checking code quality...'
                sh 'mvn sonar:sonar'
            }
        }
        
        stage('Build Docker Image') {
            steps {
                echo 'Building Docker image...'
                sh "docker build -t ${DOCKER_REPO}/${APP_NAME}:${VERSION} ."
                sh "docker tag ${DOCKER_REPO}/${APP_NAME}:${VERSION} ${DOCKER_REPO}/${APP_NAME}:latest"
            }
        }
        
        stage('Push Docker Image') {
            steps {
                echo 'Pushing Docker image to registry...'
                sh "docker login -u ${DOCKER_USERNAME} -p ${DOCKER_PASSWORD} ${DOCKER_REPO}"
                sh "docker push ${DOCKER_REPO}/${APP_NAME}:${VERSION}"
                sh "docker push ${DOCKER_REPO}/${APP_NAME}:latest"
            }
        }
        
        stage('Deploy to Dev') {
            when {
                branch 'develop'
            }
            steps {
                echo 'Deploying to development environment...'
                sh 'kubectl apply -f kubernetes/dev/deployment.yaml'
                sh 'kubectl apply -f kubernetes/dev/service.yaml'
            }
        }
        
        stage('Deploy to Staging') {
            when {
                branch 'master'
            }
            steps {
                echo 'Deploying to staging environment...'
                sh 'kubectl apply -f kubernetes/staging/deployment.yaml'
                sh 'kubectl apply -f kubernetes/staging/service.yaml'
            }
        }
        
        stage('Deploy to Production') {
            when {
                branch 'master'
            }
            steps {
                echo 'Deploying to production environment...'
                input message: 'Deploy to production?', ok: 'Deploy'
                sh 'kubectl apply -f kubernetes/prod/deployment.yaml'
                sh 'kubectl apply -f kubernetes/prod/service.yaml'
            }
        }
    }
    
    post {
        success {
            echo 'Pipeline succeeded!'
            slackSend channel: '#deployments', message: "${APP_NAME} build ${VERSION} deployed successfully."
        }
        failure {
            echo 'Pipeline failed!'
            slackSend channel: '#deployments', color: 'danger', message: "${APP_NAME} build ${VERSION} failed."
        }
    }
}
```

### 5.4 ç›‘æ§ä¸å‘Šè­¦

ç›‘æ§ä¸å‘Šè­¦æ˜¯å¾®æœåŠ¡æ¶æ„ä¸­çš„é‡è¦è¿ç»´å®è·µï¼Œå®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬åŠæ—¶å‘ç°å’Œè§£å†³é—®é¢˜ã€‚

**æ ¸å¿ƒæŒ‡æ ‡**ï¼š
- **å¥åº·çŠ¶æ€**ï¼šæœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
- **æ€§èƒ½æŒ‡æ ‡**ï¼šå“åº”æ—¶é—´ã€ååé‡ã€é”™è¯¯ç‡ç­‰
- **èµ„æºåˆ©ç”¨ç‡**ï¼šCPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œç­‰èµ„æºçš„ä½¿ç”¨æƒ…å†µ
- **ä¸šåŠ¡æŒ‡æ ‡**ï¼šè®¢å•æ•°é‡ã€ç”¨æˆ·æ³¨å†Œæ•°ç­‰ä¸šåŠ¡ç›¸å…³æŒ‡æ ‡

**å¸¸è§å®ç°**ï¼š
- **Prometheus + Grafana**ï¼šæµè¡Œçš„ç›‘æ§å’Œå¯è§†åŒ–è§£å†³æ–¹æ¡ˆ
- **ELK Stack**ï¼šæ—¥å¿—æ”¶é›†ã€å­˜å‚¨å’Œåˆ†æå¹³å°
- **Sentry**ï¼šé”™è¯¯è·Ÿè¸ªå’Œç›‘æ§å·¥å…·
- **Spring Boot Actuator**ï¼šSpring Bootå†…ç½®çš„ç›‘æ§å·¥å…·
- **SkyWalking**ï¼šå›½äº§å¼€æºçš„APMç³»ç»Ÿ

**Prometheusé…ç½®ç¤ºä¾‹**ï¼š

```yaml
# prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'spring-actuator'
    metrics_path: '/actuator/prometheus'
    scrape_interval: 5s
    static_configs:
      - targets: ['product-service:8080', 'order-service:8080', 'api-gateway:8080']
    
  - job_name: 'kubernetes-apiservers'
    kubernetes_sd_configs:
    - role: endpoints
    scheme: https
    tls_config:
      ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    relabel_configs:
    - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
      action: keep
      regex: default;kubernetes;https

  - job_name: 'kubernetes-pods'
    kubernetes_sd_configs:
    - role: pod
    relabel_configs:
    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
      action: keep
      regex: true
    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
      action: replace
      target_label: __metrics_path__
      regex: (.+)
    - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
      action: replace
      regex: ([^:]+)(?::\d+)?;(\d+)
      replacement: $1:$2
      target_label: __address__
    - action: labelmap
      regex: __meta_kubernetes_pod_label_(.+)
    - source_labels: [__meta_kubernetes_namespace]
      action: replace
      target_label: kubernetes_namespace
    - source_labels: [__meta_kubernetes_pod_name]
      action: replace
      target_label: kubernetes_pod_name
```

## å…­ã€å¾®æœåŠ¡å®‰å…¨

å¾®æœåŠ¡æ¶æ„ä¸­çš„å®‰å…¨æ˜¯ä¸€ä¸ªé‡è¦çš„è€ƒè™‘å› ç´ ï¼Œéœ€è¦ä»å¤šä¸ªå±‚é¢è¿›è¡Œä¿æŠ¤ã€‚

### 6.1 è®¤è¯ä¸æˆæƒ

è®¤è¯ä¸æˆæƒæ˜¯å¾®æœåŠ¡å®‰å…¨çš„åŸºç¡€ï¼Œå®ƒç¡®ä¿åªæœ‰åˆæ³•çš„ç”¨æˆ·å’ŒæœåŠ¡èƒ½å¤Ÿè®¿é—®ç³»ç»Ÿèµ„æºã€‚

**å¸¸è§å®ç°**ï¼š
- **OAuth 2.0**ï¼šæˆæƒæ¡†æ¶
- **JWT (JSON Web Token)**ï¼šç”¨äºå®‰å…¨åœ°ä¼ è¾“ä¿¡æ¯çš„æ ‡å‡†
- **Spring Security**ï¼šSpringæ¡†æ¶çš„å®‰å…¨æ¨¡å—
- **Keycloak**ï¼šå¼€æºçš„èº«ä»½å’Œè®¿é—®ç®¡ç†è§£å†³æ–¹æ¡ˆ
- **LDAP/Active Directory**ï¼šç›®å½•æœåŠ¡ï¼Œç”¨äºç”¨æˆ·è®¤è¯å’Œæˆæƒ

**å®ç°ç¤ºä¾‹ï¼ˆSpring Security + JWTï¼‰**ï¼š

```java
@Configuration
@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    @Autowired
    private JwtAuthenticationFilter jwtAuthFilter;
    @Autowired
    private CustomUserDetailsService userDetailsService;
    
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
            .csrf().disable()
            .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)
            .and()
            .authorizeRequests()
            .antMatchers("/api/auth/**").permitAll()
            .antMatchers("/api/public/**").permitAll()
            .antMatchers("/actuator/**").hasRole("ADMIN")
            .anyRequest().authenticated()
            .and()
            .addFilterBefore(jwtAuthFilter, UsernamePasswordAuthenticationFilter.class);
    }
    
    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        auth.userDetailsService(userDetailsService).passwordEncoder(passwordEncoder());
    }
    
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
    
    @Bean
    @Override
    public AuthenticationManager authenticationManagerBean() throws Exception {
        return super.authenticationManagerBean();
    }
}

@Component
public class JwtAuthenticationFilter extends OncePerRequestFilter {
    @Autowired
    private JwtTokenProvider tokenProvider;
    @Autowired
    private CustomUserDetailsService userDetailsService;
    
    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {
        try {
            // è·å–JWT token
            String token = getJwtFromRequest(request);
            
            if (StringUtils.hasText(token) && tokenProvider.validateToken(token)) {
                // ä»tokenä¸­è·å–ç”¨æˆ·ID
                Long userId = tokenProvider.getUserIdFromJWT(token);
                
                // åŠ è½½ç”¨æˆ·ä¿¡æ¯
                UserDetails userDetails = userDetailsService.loadUserByUsername(userId.toString());
                UsernamePasswordAuthenticationToken authentication = new UsernamePasswordAuthenticationToken(
                        userDetails, null, userDetails.getAuthorities());
                authentication.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));
                
                // è®¾ç½®è®¤è¯ä¿¡æ¯
                SecurityContextHolder.getContext().setAuthentication(authentication);
            }
        } catch (Exception ex) {
            logger.error("Could not set user authentication in security context", ex);
        }
        
        filterChain.doFilter(request, response);
    }
    
    private String getJwtFromRequest(HttpServletRequest request) {
        String bearerToken = request.getHeader("Authorization");
        if (StringUtils.hasText(bearerToken) && bearerToken.startsWith("Bearer ")) {
            return bearerToken.substring(7);
        }
        return null;
    }
}

@Component
public class JwtTokenProvider {
    @Value("${app.jwtSecret}")
    private String jwtSecret;
    
    @Value("${app.jwtExpirationInMs}")
    private int jwtExpirationInMs;
    
    public String generateToken(Authentication authentication) {
        UserPrincipal userPrincipal = (UserPrincipal) authentication.getPrincipal();
        
        Date now = new Date();
        Date expiryDate = new Date(now.getTime() + jwtExpirationInMs);
        
        return Jwts.builder()
                .setSubject(Long.toString(userPrincipal.getId()))
                .setIssuedAt(new Date())
                .setExpiration(expiryDate)
                .signWith(SignatureAlgorithm.HS512, jwtSecret)
                .compact();
    }
    
    public Long getUserIdFromJWT(String token) {
        Claims claims = Jwts.parser()
                .setSigningKey(jwtSecret)
                .parseClaimsJws(token)
                .getBody();
        
        return Long.parseLong(claims.getSubject());
    }
    
    public boolean validateToken(String authToken) {
        try {
            Jwts.parser().setSigningKey(jwtSecret).parseClaimsJws(authToken);
            return true;
        } catch (SignatureException ex) {
            logger.error("Invalid JWT signature");
        } catch (MalformedJwtException ex) {
            logger.error("Invalid JWT token");
        } catch (ExpiredJwtException ex) {
            logger.error("Expired JWT token");
        } catch (UnsupportedJwtException ex) {
            logger.error("Unsupported JWT token");
        } catch (IllegalArgumentException ex) {
            logger.error("JWT claims string is empty");
        }
        return false;
    }
}
```

### 6.2 APIå®‰å…¨

APIå®‰å…¨æ˜¯å¾®æœåŠ¡æ¶æ„ä¸­çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œå®ƒç¡®ä¿APIä¸è¢«æœªæˆæƒè®¿é—®å’Œæ»¥ç”¨ã€‚

**æ ¸å¿ƒæªæ–½**ï¼š
- **è®¤è¯ä¸æˆæƒ**ï¼šç¡®ä¿åªæœ‰åˆæ³•çš„ç”¨æˆ·å’ŒæœåŠ¡èƒ½å¤Ÿè®¿é—®API
- **è¾“å…¥éªŒè¯**ï¼šéªŒè¯æ‰€æœ‰è¾“å…¥æ•°æ®ï¼Œé˜²æ­¢æ³¨å…¥æ”»å‡»
- **è¾“å‡ºç¼–ç **ï¼šå¯¹è¾“å‡ºæ•°æ®è¿›è¡Œç¼–ç ï¼Œé˜²æ­¢XSSæ”»å‡»
- **é™æµæ§åˆ¶**ï¼šé™åˆ¶APIçš„è®¿é—®é¢‘ç‡ï¼Œé˜²æ­¢DoSæ”»å‡»
- **APIç½‘å…³**ï¼šä½¿ç”¨APIç½‘å…³è¿›è¡Œç»Ÿä¸€çš„å®‰å…¨æ§åˆ¶
- **APIæ–‡æ¡£**ï¼šæä¾›æ¸…æ™°çš„APIæ–‡æ¡£ï¼Œæ˜ç¡®APIçš„ä½¿ç”¨æ–¹å¼å’Œé™åˆ¶

**å®ç°ç¤ºä¾‹ï¼ˆAPIé™æµï¼‰**ï¼š

```java
@Configuration
public class RateLimiterConfig {
    @Bean
    public KeyResolver userKeyResolver() {
        return exchange -> Mono.justOrEmpty(exchange.getRequest().getHeaders().getFirst("User-Id"))
                .defaultIfEmpty("anonymous");
    }
    
    @Bean
    public RedisRateLimiter redisRateLimiter() {
        // æ¯ç§’å…è®¸10ä¸ªè¯·æ±‚ï¼Œæœ€å¤§çªå‘20ä¸ª
        return new RedisRateLimiter(10, 20);
    }
}

@RestController
@RequestMapping("/api/products")
public class ProductController {
    @Autowired
    private ProductService productService;
    
    @GetMapping
    @RateLimiter(name = "productService", fallbackMethod = "getProductsFallback")
    public List<Product> getProducts() {
        return productService.findAll();
    }
    
    @GetMapping("/{id}")
    @RateLimiter(name = "productService", fallbackMethod = "getProductFallback")
    public Product getProduct(@PathVariable Long id) {
        return productService.findById(id)
                .orElseThrow(() -> new ProductNotFoundException("Product not found: " + id));
    }
    
    // é™çº§æ–¹æ³•
    public List<Product> getProductsFallback(Throwable t) {
        // è¿”å›çƒ­é—¨å•†å“åˆ—è¡¨æˆ–ç©ºåˆ—è¡¨
        return Collections.emptyList();
    }
    
    public ResponseEntity<?> getProductFallback(Long id, Throwable t) {
        // è¿”å›é”™è¯¯ä¿¡æ¯
        return ResponseEntity.status(HttpStatus.TOO_MANY_REQUESTS)
                .body("Too many requests. Please try again later.");
    }
}
```

### 6.3 æ•°æ®å®‰å…¨

æ•°æ®å®‰å…¨æ˜¯å¾®æœåŠ¡æ¶æ„ä¸­çš„é‡è¦è€ƒè™‘å› ç´ ï¼Œå®ƒç¡®ä¿æ•°æ®ä¸è¢«æœªæˆæƒè®¿é—®ã€ä¿®æ”¹æˆ–æ³„éœ²ã€‚

**æ ¸å¿ƒæªæ–½**ï¼š
- **æ•°æ®åŠ å¯†**ï¼šå¯¹æ•æ„Ÿæ•°æ®è¿›è¡ŒåŠ å¯†å­˜å‚¨å’Œä¼ è¾“
- **è®¿é—®æ§åˆ¶**ï¼šå¯¹æ•°æ®çš„è®¿é—®è¿›è¡Œä¸¥æ ¼çš„æƒé™æ§åˆ¶
- **æ•°æ®è„±æ•**ï¼šå¯¹æ•æ„Ÿæ•°æ®è¿›è¡Œè„±æ•å¤„ç†
- **æ•°æ®å¤‡ä»½ä¸æ¢å¤**ï¼šå®šæœŸå¤‡ä»½æ•°æ®ï¼Œå¹¶åˆ¶å®šæ¢å¤è®¡åˆ’
- **å®¡è®¡æ—¥å¿—**ï¼šè®°å½•æ•°æ®çš„è®¿é—®å’Œä¿®æ”¹å†å²
- **APIå®‰å…¨**ï¼šç¡®ä¿APIä¸è¢«æœªæˆæƒè®¿é—®å’Œæ»¥ç”¨

**å®ç°ç¤ºä¾‹ï¼ˆæ•°æ®åŠ å¯†ï¼‰**ï¼š

```java
@Configuration
public class EncryptionConfig {
    @Value("${app.encryption.key}")
    private String encryptionKey;
    
    @Bean
    public SecretKey secretKey() {
        // ä»é…ç½®ä¸­è·å–å¯†é’¥ï¼Œå®é™…åº”ç”¨ä¸­åº”è¯¥ä½¿ç”¨å¯†é’¥ç®¡ç†æœåŠ¡
        byte[] keyBytes = Base64.getDecoder().decode(encryptionKey);
        return new SecretKeySpec(keyBytes, "AES");
    }
    
    @Bean
    public Encryptor encryptor(SecretKey secretKey) {
        return new AesGcmEncryptor(secretKey);
    }
}

@Service
public class EncryptionService {
    @Autowired
    private Encryptor encryptor;
    
    public String encrypt(String plainText) {
        return encryptor.encrypt(plainText);
    }
    
    public String decrypt(String encryptedText) {
        return encryptor.decrypt(encryptedText);
    }
}

@Entity
@Table(name = "users")
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String username;
    
    private String password;
    
    @Convert(converter = EncryptedStringConverter.class)
    private String email;
    
    @Convert(converter = EncryptedStringConverter.class)
    private String phoneNumber;
    
    // getters and setters
}

@Converter
public class EncryptedStringConverter implements AttributeConverter<String, String> {
    @Autowired
    private EncryptionService encryptionService;
    
    @Override
    public String convertToDatabaseColumn(String attribute) {
        if (attribute == null) {
            return null;
        }
        return encryptionService.encrypt(attribute);
    }
    
    @Override
    public String convertToEntityAttribute(String dbData) {
        if (dbData == null) {
            return null;
        }
        return encryptionService.decrypt(dbData);
    }
}
```

## ä¸ƒã€å¾®æœåŠ¡å®æ–½æœ€ä½³å®è·µ

### 7.1 æœåŠ¡è®¾è®¡æœ€ä½³å®è·µ

- **æ˜ç¡®çš„æœåŠ¡è¾¹ç•Œ**ï¼šä½¿ç”¨é¢†åŸŸé©±åŠ¨è®¾è®¡(DDD)çš„é™ç•Œä¸Šä¸‹æ–‡æ¦‚å¿µæ¥å®šä¹‰æœåŠ¡è¾¹ç•Œ
- **å•ä¸€èŒè´£åŸåˆ™**ï¼šæ¯ä¸ªæœåŠ¡åªè´Ÿè´£ä¸€ä¸ªæ˜ç¡®çš„ä¸šåŠ¡åŠŸèƒ½
- **æ¥å£å¥‘çº¦è®¾è®¡**ï¼šä½¿ç”¨OpenAPI/Swaggerç­‰å·¥å…·å®šä¹‰æ¸…æ™°çš„APIå¥‘çº¦
- **ç‰ˆæœ¬æ§åˆ¶**ï¼šä¸ºAPIæä¾›ç‰ˆæœ¬æ§åˆ¶ï¼Œç¡®ä¿å‘åå…¼å®¹æ€§
- **æ–‡æ¡£åŒ–**ï¼šä¸ºæœåŠ¡æ¥å£å’ŒåŠŸèƒ½æä¾›è¯¦ç»†çš„æ–‡æ¡£
- **é”™è¯¯å¤„ç†**ï¼šè®¾è®¡ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œæä¾›æœ‰æ„ä¹‰çš„é”™è¯¯ä¿¡æ¯
- **è¶…æ—¶æ§åˆ¶**ï¼šä¸ºæ‰€æœ‰æœåŠ¡è°ƒç”¨è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
- **é‡è¯•æœºåˆ¶**ï¼šä¸ºå¯èƒ½å¤±è´¥çš„æ“ä½œè®¾è®¡åˆç†çš„é‡è¯•æœºåˆ¶

### 7.2 æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ

- **ç¼“å­˜ç­–ç•¥**ï¼šåˆç†ä½¿ç”¨ç¼“å­˜å‡å°‘æ•°æ®åº“è®¿é—®
- **æ•°æ®åº“ä¼˜åŒ–**ï¼šä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢ï¼Œä½¿ç”¨ç´¢å¼•ï¼Œé¿å…N+1æŸ¥è¯¢
- **å¼‚æ­¥å¤„ç†**ï¼šå°†è€—æ—¶æ“ä½œè½¬ä¸ºå¼‚æ­¥å¤„ç†
- **æ‰¹é‡å¤„ç†**ï¼šåˆå¹¶å¤šæ¬¡è¯·æ±‚ä¸ºæ‰¹é‡è¯·æ±‚
- **èµ„æºé™åˆ¶**ï¼šä¸ºæœåŠ¡è®¾ç½®åˆç†çš„èµ„æºé™åˆ¶ï¼ˆCPUã€å†…å­˜ç­‰ï¼‰
- **è¿æ¥æ± **ï¼šåˆç†é…ç½®æ•°æ®åº“è¿æ¥æ± å’ŒHTTPè¿æ¥æ± 
- **å“åº”å‹ç¼©**ï¼šå¯¹APIå“åº”è¿›è¡Œå‹ç¼©ï¼Œå‡å°‘ç½‘ç»œä¼ è¾“é‡
- **CDNåŠ é€Ÿ**ï¼šå¯¹é™æ€èµ„æºä½¿ç”¨CDNåŠ é€Ÿ

### 7.3 å¯è§‚æµ‹æ€§æœ€ä½³å®è·µ

- **ç»Ÿä¸€æ—¥å¿—æ ¼å¼**ï¼šä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—ï¼Œæ–¹ä¾¿æ—¥å¿—æ”¶é›†å’Œåˆ†æ
- **åˆ†å¸ƒå¼è¿½è¸ª**ï¼šä½¿ç”¨åˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿè·Ÿè¸ªè¯·æ±‚çš„å®Œæ•´è·¯å¾„
- **ç›‘æ§æŒ‡æ ‡**ï¼šæ”¶é›†å…³é”®ä¸šåŠ¡æŒ‡æ ‡å’ŒæŠ€æœ¯æŒ‡æ ‡
- **å‘Šè­¦æœºåˆ¶**ï¼šè®¾ç½®åˆç†çš„å‘Šè­¦é˜ˆå€¼å’Œå‘Šè­¦æ–¹å¼
- **å¥åº·æ£€æŸ¥**ï¼šä¸ºæ¯ä¸ªæœåŠ¡æä¾›å¥åº·æ£€æŸ¥ç«¯ç‚¹
- **é“¾è·¯åˆ†æ**ï¼šåˆ†ææœåŠ¡è°ƒç”¨é“¾ï¼Œè¯†åˆ«æ€§èƒ½ç“¶é¢ˆ
- **å®¹é‡è§„åˆ’**ï¼šåŸºäºç›‘æ§æ•°æ®è¿›è¡Œå®¹é‡è§„åˆ’

### 7.4 å›¢é˜Ÿåä½œæœ€ä½³å®è·µ

- **ç»„ç»‡å¯¹é½**ï¼šå›¢é˜Ÿç»“æ„ä¸æœåŠ¡è¾¹ç•Œå¯¹é½ï¼Œé‡‡ç”¨ç‰¹æ€§å›¢é˜Ÿæˆ–å¾®æœåŠ¡å›¢é˜Ÿ
- **DevOpsæ–‡åŒ–**ï¼šæ¨å¹¿DevOpsæ–‡åŒ–ï¼Œé¼“åŠ±å¼€å‘å’Œè¿ç»´å›¢é˜Ÿåä½œ
- **è‡ªåŠ¨åŒ–**ï¼šè‡ªåŠ¨åŒ–æ„å»ºã€æµ‹è¯•ã€éƒ¨ç½²å’Œç›‘æ§æµç¨‹
- **çŸ¥è¯†å…±äº«**ï¼šå»ºç«‹çŸ¥è¯†å…±äº«æœºåˆ¶ï¼Œé¿å…çŸ¥è¯†å­¤å²›
- **ä»£ç è¯„å®¡**ï¼šå®æ–½ä»£ç è¯„å®¡ï¼Œæé«˜ä»£ç è´¨é‡
- **æ–‡æ¡£åŒ–**ï¼šä¸ºç³»ç»Ÿæ¶æ„ã€æœåŠ¡æ¥å£å’Œä¸šåŠ¡æµç¨‹æä¾›è¯¦ç»†çš„æ–‡æ¡£
- **æ²Ÿé€šæœºåˆ¶**ï¼šå»ºç«‹æœ‰æ•ˆçš„æ²Ÿé€šæœºåˆ¶ï¼Œç¡®ä¿å›¢é˜Ÿé—´ä¿¡æ¯å…±äº«

## å…«ã€å¾®æœåŠ¡æ¶æ„æ¼”è¿›

### 8.1 ä»å•ä½“åˆ°å¾®æœåŠ¡çš„æ¼”è¿›

ä»å•ä½“åº”ç”¨æ¼”è¿›åˆ°å¾®æœåŠ¡æ¶æ„æ˜¯ä¸€ä¸ªæ¸è¿›çš„è¿‡ç¨‹ï¼Œä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„æ¼”è¿›ç­–ç•¥ï¼š

1. **è¯†åˆ«å€™é€‰æœåŠ¡**ï¼šåˆ†æå•ä½“åº”ç”¨ï¼Œè¯†åˆ«å¯ä»¥æ‹†åˆ†ä¸ºç‹¬ç«‹æœåŠ¡çš„æ¨¡å—
2. **æ„å»ºå¾®æœåŠ¡åŸºç¡€æ¶æ„**ï¼šæ­å»ºæœåŠ¡æ³¨å†Œå‘ç°ã€é…ç½®ä¸­å¿ƒã€APIç½‘å…³ç­‰åŸºç¡€è®¾æ–½
3. **å°æ­¥å¿«è·‘**ï¼šå…ˆä»ç®€å•çš„æ¨¡å—å¼€å§‹æ‹†åˆ†ï¼Œé€æ­¥ç§¯ç´¯ç»éªŒ
4. ** strangler patternï¼ˆç»æ€è€…æ¨¡å¼ï¼‰**ï¼šæ–°å»ºæœåŠ¡æ¥æ›¿ä»£å•ä½“åº”ç”¨çš„éƒ¨åˆ†åŠŸèƒ½ï¼Œé€æ­¥æ›¿æ¢æ•´ä¸ªåº”ç”¨
5. **æ•°æ®è¿ç§»**ï¼šåˆ¶å®šè¯¦ç»†çš„æ•°æ®è¿ç§»è®¡åˆ’ï¼Œç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§å’Œå®Œæ•´æ€§
6. **é€æ­¥æ·˜æ±°å•ä½“**ï¼šéšç€å¾®æœåŠ¡çš„å¢å¤šï¼Œé€æ­¥å‡å°‘å•ä½“åº”ç”¨çš„åŠŸèƒ½ï¼Œæœ€ç»ˆå®Œå…¨æ·˜æ±°

### 8.2 å¾®æœåŠ¡æ¶æ„çš„æˆç†Ÿåº¦æ¨¡å‹

å¾®æœåŠ¡æ¶æ„çš„æˆç†Ÿåº¦å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªé˜¶æ®µï¼š

1. **åˆå§‹é˜¶æ®µ**ï¼šåŸºæœ¬çš„æœåŠ¡æ‹†åˆ†ï¼Œä½†åŸºç¡€è®¾æ–½ä¸å®Œå–„
2. **æˆé•¿é˜¶æ®µ**ï¼šå®Œå–„åŸºç¡€è®¾æ–½ï¼Œå®ç°æœåŠ¡æ³¨å†Œå‘ç°ã€é…ç½®ä¸­å¿ƒç­‰åŠŸèƒ½
3. **æˆç†Ÿé˜¶æ®µ**ï¼šå®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²ã€ç›‘æ§å‘Šè­¦ã€é“¾è·¯è¿½è¸ªç­‰é«˜çº§åŠŸèƒ½
4. **ä¼˜åŒ–é˜¶æ®µ**ï¼šæŒç»­ä¼˜åŒ–æ¶æ„ï¼Œæé«˜ç³»ç»Ÿæ€§èƒ½ã€å¯é æ€§å’Œå¯ç»´æŠ¤æ€§
5. **åˆ›æ–°é˜¶æ®µ**ï¼šæ¢ç´¢æ–°æŠ€æœ¯å’Œæ–°æ–¹æ³•ï¼Œå¦‚Service Meshã€Serverlessç­‰

### 8.3 å¾®æœåŠ¡æ¶æ„çš„æŒ‘æˆ˜ä¸åº”å¯¹

**æŒ‘æˆ˜**ï¼š
- åˆ†å¸ƒå¼ç³»ç»Ÿçš„å¤æ‚æ€§
- æœåŠ¡é—´é€šä¿¡çš„å»¶è¿Ÿå’Œå¯é æ€§
- æ•°æ®ä¸€è‡´æ€§çš„ä¿è¯
- æœåŠ¡ä¾èµ–å…³ç³»çš„ç®¡ç†
- è¿ç»´å¤æ‚åº¦çš„å¢åŠ 
- æµ‹è¯•éš¾åº¦çš„æé«˜
- å›¢é˜Ÿåä½œçš„æŒ‘æˆ˜

**åº”å¯¹ç­–ç•¥**ï¼š
- é‡‡ç”¨æˆç†Ÿçš„å¾®æœåŠ¡æ¡†æ¶å’Œå·¥å…·
- è®¾è®¡åˆç†çš„æœåŠ¡æ‹†åˆ†ç­–ç•¥
- å®ç°å®Œå–„çš„ç›‘æ§å’Œå¯è§‚æµ‹æ€§
- å»ºç«‹è‡ªåŠ¨åŒ–çš„CI/CDæµæ°´çº¿
- æ¨å¹¿DevOpsæ–‡åŒ–
- åŠ å¼ºå›¢é˜Ÿåä½œå’ŒçŸ¥è¯†å…±äº«
- æŒç»­ä¼˜åŒ–å’Œæ¼”è¿›æ¶æ„